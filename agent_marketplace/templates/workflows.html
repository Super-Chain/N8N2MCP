{% extends "base.html" %}

{% block title %}N8N - Agent Marketplace{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="header-top">
            <div class="header-left">
                <!-- Left side content if needed -->
            </div>
            <div class="user-profile" id="userProfile">
                <button id="loginBtn" class="login-btn" onclick="showAuthModal()" style="display: block;">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In
                </button>
                <div id="userInfo" class="user-info" style="display: none;">
                    <img id="userAvatar" class="user-avatar" src="/static/images/default-avatar.png" alt="" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">
                    <span id="userName">User</span>
                    <span id="authStatus" style="font-size: 10px; color: #10b981; margin-left: 8px;">‚óè</span>
                    <button id="logoutBtn" onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        
        <h1 class="main-title">N8N <span class="highlight">2</span> MCP</h1>
        <p class="subtitle">Import N8N workflow templates and deploy them as your MCP servers</p>
    </div>

    <!-- Workflow Import Section -->
    <div class="search-section">
        <div class="workflow-import-header">
            <h3 style="color: #e5e5e5; margin-bottom: 10px;">Import N8N Workflow Template</h3>
            <p style="color: #8a8aa0; margin-bottom: 20px;">Paste an N8N template URL to automatically import and configure the workflow</p>
        </div>
        
        <div class="url-input-section">
            <input type="text" class="search-bar" placeholder="https://n8n.io/workflows/5048-generate-an-ai-summary-of-your-notion-comments/" id="templateUrlInput">
            <button class="import-btn" onclick="importWorkflowFromUrl()">
                <i class="fas fa-download"></i>
                Import Template
            </button>
        </div>

        <div class="or-divider">
            <span>OR</span>
        </div>
        
        <div class="upload-methods">
            <!-- File Upload -->
            <div class="upload-method" id="fileUploadMethod">
                <div class="upload-icon">
                    <i class="fas fa-file-upload"></i>
                </div>
                <h5>Upload JSON File</h5>
                <p>Name your workflow and upload your N8N workflow JSON file</p>
                
                <!-- Workflow Name Input -->
                <div style="margin: 20px 0;">
                    <label style="color: #e5e5e5; display: block; margin-bottom: 8px; font-weight: 500;">
                        Workflow Name <span style="color: #e21aff;">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="userWorkflowName" 
                        placeholder="Enter a name for your workflow..."
                        required
                        style="width: 100%; padding: 12px 15px; background: #1a1a2e; border: 2px solid #4e4e7a; border-radius: 8px; color: #e5e5e5; font-size: 14px; transition: border-color 0.3s;"
                        onfocus="this.style.borderColor='#e21aff'"
                        onblur="this.style.borderColor='#4e4e7a'"
                    >
                    <small style="color: #8a8aa0; font-size: 12px; margin-top: 5px; display: block;">Give your workflow a descriptive name that you'll recognize later</small>
                </div>
                
                <input type="file" id="workflowFile" accept=".json" style="display: none;" onchange="handleFileUpload(event)">
                <button class="method-btn" onclick="validateAndUploadFile()">
                    <i class="fas fa-folder-open me-2"></i>Browse Files
                </button>
            </div>
            
            <!-- JSON Paste -->
            <div class="upload-method" id="jsonPasteMethod">
                <div class="upload-icon">
                    <i class="fas fa-code"></i>
                </div>
                <h5>Paste JSON</h5>
                <p>Name your workflow and paste your N8N workflow JSON</p>
                
                <!-- Workflow Name Input for JSON Paste -->
                <div style="margin: 20px 0;">
                    <label style="color: #e5e5e5; display: block; margin-bottom: 8px; font-weight: 500;">
                        Workflow Name <span style="color: #e21aff;">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="jsonWorkflowName" 
                        placeholder="Enter a name for your workflow..."
                        required
                        style="width: 100%; padding: 12px 15px; background: #1a1a2e; border: 2px solid #4e4e7a; border-radius: 8px; color: #e5e5e5; font-size: 14px; transition: border-color 0.3s;"
                        onfocus="this.style.borderColor='#e21aff'"
                        onblur="this.style.borderColor='#4e4e7a'"
                    >
                    <small style="color: #8a8aa0; font-size: 12px; margin-top: 5px; display: block;">Give your workflow a descriptive name that you'll recognize later</small>
                </div>
                
                <button class="method-btn" onclick="showJsonEditor()">
                    <i class="fas fa-edit me-2"></i>Open Editor
                </button>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading-spinner" id="loadingSpinner" style="display: none;">
        <div class="spinner"></div>
        <h3 style="color: #e5e5e5; margin-top: 20px;">Processing workflow...</h3>
        <p style="color: #8a8aa0;">Analyzing nodes and extracting credential requirements</p>
    </div>

    <!-- Streamlined Workflow Configuration -->
    <div class="workflow-configuration" id="workflowConfiguration" style="display: none;">
        <!-- Workflow Info Card -->
        <div class="workflow-info-card">
            <div class="workflow-header">
                <div class="workflow-icon">üîß</div>
                <div class="workflow-details">
                    <h3 id="workflowTitle">Workflow Preview</h3>
                    <p id="workflowDescription"></p>
                </div>
            </div>
            
            <div class="workflow-stats">
                <div class="stat-item">
                    <span class="stat-number" id="nodeCount">0</span>
                    <span class="stat-label">Nodes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="credentialCount">0</span>
                    <span class="stat-label">Services</span>
                </div>
            </div>
        </div>

        <!-- Credential Configuration Section -->
        <div class="credential-configuration" id="credentialConfiguration">
            <h3 style="color: #e5e5e5; margin-bottom: 15px;">
                <i class="fas fa-key me-2"></i>Configure Credentials
            </h3>
            <p style="color: #8a8aa0; margin-bottom: 30px;">Set up your API keys and credentials for the workflow services</p>
            <div id="credentialFormContainer"></div>
        </div>

        <!-- Deploy Section -->
        <div class="deploy-section" id="deploySection">
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <button onclick="deployWorkflowToN8N()" class="deploy-btn">
                    <i class="fas fa-rocket me-2"></i>Deploy Agent
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Workflows Section -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <div>
                <h2 style="margin: 0; color: #e5e5e5; font-family: 'Press Start 2P', monospace; font-size: 0.8em;">üîß Manage Workflows</h2>
                <p style="margin: 5px 0 0 0; color: #8a8aa0; font-family: 'Press Start 2P', monospace; font-size: 0.5em;">Configure and deploy your existing workflows</p>
            </div>
            <button onclick="loadUserUploadedWorkflows()" class="category-btn" style="margin: 0; font-family: 'Press Start 2P', monospace; font-size: 0.6em;">
                <i class="fas fa-refresh me-2"></i>Refresh
            </button>
        </div>

        <!-- Workflow Type Tabs -->
        <div class="workflow-tabs" style="margin-bottom: 30px;">
            <button class="tab-btn active" onclick="switchWorkflowTab('uploaded')" id="uploadedTab" style="font-family: 'Press Start 2P', monospace; font-size: 0.6em;">
                <i class="fas fa-upload me-2"></i>My Workflows
            </button>

        </div>

        <!-- Uploaded Workflows Content -->
        <div id="uploadedWorkflowsContent" class="tab-content active">
            <div id="userWorkflowsContainer" class="workflows-grid">
                <!-- User workflows will be loaded here -->
            </div>
        </div>


    </div>

    <!-- MCP Servers Section -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <div>
                <h2 style="margin: 0; color: #e5e5e5; font-family: 'Press Start 2P', monospace; font-size: 0.8em;">üîó MCP Servers</h2>
                <p style="margin: 5px 0 0 0; color: #8a8aa0; font-family: 'Press Start 2P', monospace; font-size: 0.5em;">Access your deployed workflow MCP endpoints</p>
            </div>
            <button onclick="loadMCPServers()" class="category-btn" style="margin: 0; font-family: 'Press Start 2P', monospace; font-size: 0.6em;">
                <i class="fas fa-refresh me-2"></i>Refresh
            </button>
        </div>

        <div id="mcpServersContainer" class="mcp-servers-grid">
            <!-- MCP servers will be loaded here -->
        </div>
    </div>

    <!-- Credential Configuration Modal (for editing existing workflows) -->
    <div id="credentialModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Configure Workflow Credentials</h2>
                <button class="close-btn" onclick="hideModal('credentialModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div id="modalCredentialForm"></div>
            </div>
        </div>
    </div>

    <!-- JSON Editor Modal -->
    <div id="jsonEditorModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">N8N Workflow JSON Editor</h2>
                <button class="close-btn" onclick="hideModal('jsonEditorModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="color: #e5e5e5; display: block; margin-bottom: 10px;">Paste your N8N workflow JSON here:</label>
                    <textarea class="json-editor" id="jsonEditor" placeholder="Paste your N8N workflow JSON here..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="category-btn" onclick="validateJson()">
                        <i class="fas fa-check-circle me-2"></i>Validate JSON
                    </button>
                    <button class="category-btn" onclick="formatJson()">
                        <i class="fas fa-magic me-2"></i>Format JSON
                    </button>
                    <button class="category-btn active" onclick="processJsonFromEditor()">
                        <i class="fas fa-cogs me-2"></i>Process Workflow
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Sign In</h2>
                <button class="close-btn" onclick="hideModal('authModal')">&times;</button>
            </div>
            
            <div class="modal-body">
                <p style="color: #8a8aa0; margin-bottom: 30px; text-align: center;">
                    Sign in with your preferred social account and manage your workflow credentials
                </p>
                
                <div class="auth-methods">
                    <button class="auth-btn google-btn" onclick="authenticateWith('google')">
                        Continue with Google
                    </button>
                    
                    <button class="auth-btn github-btn" onclick="authenticateWith('github')">
                        Continue with GitHub
                    </button>
                </div>
                
                <p style="color: #666; font-size: 0.9em; text-align: center; margin-top: 20px;">
                    Your credentials are encrypted and stored securely. We never share your data with third parties.
                </p>
            </div>
        </div>
    </div>

    <style>
    /* Streamlined Workflow Configuration Styles */
    .workflow-configuration {
        background: rgba(26, 26, 46, 0.8);
        border: 2px solid #4e4e7a;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 0 20px rgba(131, 58, 180, 0.3);
    }

    .workflow-info-card {
        background: rgba(31, 31, 50, 0.8);
        border: 2px solid #5e5e8a;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
    }

    .workflow-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 25px;
    }

    .workflow-icon {
        font-size: 3em;
        background: linear-gradient(90deg, #833ab4 0%, #ff0099 100%);
        width: 80px;
        height: 80px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 20px rgba(131, 58, 180, 0.5);
    }

    .workflow-details h3 {
        color: #e5e5e5;
        margin-bottom: 10px;
        font-size: 1.5em;
    }

    .workflow-details p {
        color: #8a8aa0;
        line-height: 1.4;
    }

    .workflow-stats {
        display: flex;
        justify-content: space-around;
        gap: 20px;
    }

    .stat-item {
        text-align: center;
        padding: 20px;
        background: rgba(131, 58, 180, 0.2);
        border-radius: 15px;
        border: 2px solid #4e4e7a;
        flex: 1;
    }

    .stat-number {
        display: block;
        font-size: 2em;
        color: #e21aff;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #8a8aa0;
        text-transform: uppercase;
        font-size: 0.8em;
        letter-spacing: 1px;
    }

    .credential-configuration {
        background: rgba(31, 31, 50, 0.6);
        border: 2px solid #5e5e8a;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
    }

    .deploy-section {
        text-align: center;
        padding: 20px;
        background: rgba(31, 31, 50, 0.4);
        border-radius: 15px;
        border: 2px dashed #4e4e7a;
    }

    /* Rest of existing styles remain the same */
    .workflow-import-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .url-input-section {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        align-items: stretch;
    }

    .url-input-section .search-bar {
        flex: 1;
        margin-bottom: 0;
    }

    .import-btn {
        padding: 15px 25px;
        background: linear-gradient(90deg, #833ab4 0%, #ff0099 100%);
        border: 3px solid #e21aff;
        color: white;
        border-radius: 12px;
        cursor: pointer;
        font-weight: bold;
        font-family: 'Press Start 2P', monospace;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .import-btn:hover {
        box-shadow: 0 0 8px #ff00ff, 0 0 18px #833ab4;
        transform: translateY(-2px);
    }

    .or-divider {
        text-align: center;
        margin: 30px 0;
        position: relative;
        color: #8a8aa0;
    }

    .or-divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: #4e4e7a;
        z-index: 1;
    }

    .or-divider span {
        background: #1a1a2e;
        padding: 0 20px;
        position: relative;
        z-index: 2;
    }

    .upload-methods {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .upload-method {
        background: rgba(26, 26, 46, 0.6);
        border: 2px dashed #4e4e7a;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-method:hover {
        background: rgba(131, 58, 180, 0.2);
        border-color: #e21aff;
        transform: translateY(-5px);
    }

    .upload-method.active {
        background: rgba(131, 58, 180, 0.3);
        border-color: #e21aff;
    }

    .upload-icon {
        font-size: 3em;
        margin-bottom: 15px;
        color: #c3c3ff;
    }

    .upload-method h5 {
        color: #e5e5e5;
        margin-bottom: 10px;
        font-size: 1.1em;
    }

    .upload-method p {
        color: #8a8aa0;
        margin-bottom: 20px;
        line-height: 1.4;
    }

    .method-btn {
        padding: 10px 20px;
        background: #4e4e7a;
        border: 2px solid #6a6a8a;
        color: #e5e5e5;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
    }

    .method-btn:hover {
        background: #833ab4;
        border-color: #e21aff;
    }

    .deploy-btn {
        padding: 15px 30px;
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        border: 3px solid #28a745;
        color: white;
        border-radius: 12px;
        cursor: pointer;
        font-weight: bold;
        font-family: 'Press Start 2P', monospace;
        font-size: 0.6em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .deploy-btn:hover {
        box-shadow: 0 0 8px #28a745, 0 0 18px #20c997;
        transform: translateY(-2px);
        background: linear-gradient(90deg, #20c997 0%, #28a745 100%);
    }

    .deploy-btn:active {
        transform: translateY(0);
    }

    .json-editor {
        width: 100%;
        min-height: 300px;
        font-family: 'Press Start 2P', monospace;
        font-size: 0.9em;
        background: #1b1b30;
        color: #e2e8f0;
        border: 2px solid #4e4e7a;
        border-radius: 10px;
        padding: 20px;
        resize: vertical;
    }

    .json-editor:focus {
        outline: none;
        border-color: #e21aff;
        box-shadow: 0 0 10px rgba(226, 26, 255, 0.3);
    }

    .loading-spinner {
        text-align: center;
        padding: 60px 40px;
        background: rgba(26, 26, 46, 0.8);
        border: 2px solid #4e4e7a;
        border-radius: 20px;
        margin-bottom: 30px;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #4e4e7a;
        border-top: 4px solid #e21aff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Authentication UI Styles */
    .logout-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
    }

    .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #e5e5e5;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid #e21aff;
    }

    .auth-methods {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .auth-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 15px 25px;
        border: 3px solid #4e4e7a;
        background: #1b1b30;
        color: #e5e5e5;
        border-radius: 12px;
        cursor: pointer;
        font-family: 'Press Start 2P', monospace;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .auth-btn:hover {
        opacity: 0.8;
    }

    .google-btn {
        background: linear-gradient(90deg, #ea4335 0%, #fbbc05 100%);
        border-color: #ea4335;
        color: white;
    }

    .github-btn {
        background: linear-gradient(90deg, #24292e 0%, #57606a 100%);
        border-color: #24292e;
        color: white;
    }

    /* Credential Form Styles */
    .credential-forms {
        display: flex;
        flex-direction: column;
        gap: 25px;
    }

    .credential-section {
        background: rgba(26, 26, 46, 0.8);
        border: 2px solid #4e4e7a;
        border-radius: 15px;
        padding: 25px;
        transition: all 0.3s ease;
    }

    .credential-section:hover {
        border-color: #e21aff;
        box-shadow: 0 0 20px rgba(226, 26, 255, 0.3);
    }

    .credential-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #4e4e7a;
    }

    .credential-header h4 {
        color: #e21aff;
        margin: 0;
        font-size: 1.2em;
    }

    .credential-type {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
    }

    .credential-description {
        color: #8a8aa0;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .credential-fields {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .field-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .field-group label {
        color: #fff;
        font-weight: 600;
        font-size: 0.9em;
    }

    .field-group input {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid #4e4e7a;
        border-radius: 10px;
        padding: 12px 15px;
        color: #fff;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .field-group input:focus {
        outline: none;
        border-color: #e21aff;
        box-shadow: 0 0 10px rgba(226, 26, 255, 0.3);
    }

    .field-group input::placeholder {
        color: #8a8aa0;
    }

    .credential-actions {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #4e4e7a;
        display: flex;
        gap: 10px;
    }

    .save-credential-btn {
        flex: 1;
        min-width: 120px;
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        font-size: 0.9em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .save-credential-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* Workflow management styles */
    .workflows-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
        margin: 20px 0;
    }

    .workflow-card {
        background: rgba(26, 26, 46, 0.8);
        border: 2px solid #4e4e7a;
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .workflow-card:hover {
        background: rgba(131, 58, 180, 0.2);
        border-color: #e21aff;
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(131, 58, 180, 0.3);
    }

    .workflow-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .badge {
        font-size: 0.7em;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 4px 8px;
        border-radius: 12px;
        background: #28a745;
        color: white;
    }

    .workflow-tabs {
        display: flex;
        gap: 10px;
        border-bottom: 2px solid #4e4e7a;
        padding-bottom: 0;
    }

    .tab-btn {
        padding: 12px 20px;
        background: transparent;
        border: none;
        color: #8a8aa0;
        cursor: pointer;
        font-weight: bold;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tab-btn:hover {
        color: #e5e5e5;
        background: rgba(131, 58, 180, 0.1);
    }

    .tab-btn.active {
        color: #e21aff;
        border-bottom-color: #e21aff;
        background: rgba(226, 26, 255, 0.1);
    }

    .tab-content {
        display: none;
        padding-top: 20px;
    }

    .tab-content.active {
        display: block;
    }

    .workflow-card h4 {
        color: #e5e5e5;
        margin: 0 0 10px 0;
        font-size: 1.2em;
    }

    .workflow-card p {
        color: #8a8aa0;
        margin: 0 0 15px 0;
        font-size: 0.9em;
    }

    .workflow-card small {
        color: #666;
        font-size: 0.8em;
    }

    .workflow-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .workflow-actions button {
        padding: 8px 16px;
        border: 1px solid #4e4e7a;
        background: #1a1a2e;
        color: #e5e5e5;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8em;
        transition: all 0.2s;
    }

    .workflow-actions button:hover {
        border-color: #e21aff;
        background: #2a2a4a;
    }

    /* MCP Servers Grid Styles */
    .mcp-servers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 25px;
        margin: 20px 0;
    }

    .mcp-server-card {
        background: rgba(26, 26, 46, 0.8);
        border: 2px solid #4e4e7a;
        border-radius: 15px;
        padding: 25px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .mcp-server-card:hover {
        background: rgba(131, 58, 180, 0.2);
        border-color: #e21aff;
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(131, 58, 180, 0.3);
    }

    .mcp-server-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #e21aff 0%, #ff0099 100%);
    }

    .mcp-server-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }

    .mcp-server-icon {
        font-size: 2em;
        background: linear-gradient(90deg, #e21aff 0%, #ff0099 100%);
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 15px rgba(226, 26, 255, 0.4);
    }

    .mcp-server-info h4 {
        color: #e5e5e5;
        margin: 0 0 5px 0;
        font-size: 1.2em;
    }

    .mcp-server-info p {
        color: #8a8aa0;
        margin: 0;
        font-size: 0.9em;
    }

    .mcp-server-url {
        background: rgba(31, 31, 50, 0.8);
        border: 2px solid #5e5e8a;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .mcp-server-url-text {
        flex: 1;
        color: #e5e5e5;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        word-break: break-all;
        user-select: all;
    }

    .copy-btn {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.8em;
        font-weight: bold;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .copy-btn:hover {
        background: linear-gradient(90deg, #764ba2 0%, #667eea 100%);
        transform: scale(1.05);
    }

    .copy-btn.copied {
        background: #28a745;
    }

    .mcp-server-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #4e4e7a;
    }

    .mcp-server-status {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8em;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
    }

    .status-indicator.failed {
        background: #dc3545;
    }

    .mcp-server-date {
        color: #8a8aa0;
        font-size: 0.8em;
    }

    .header {
        background: rgba(26, 26, 46, 0.9);
        backdrop-filter: blur(15px);
        border: 2px solid #4e4e7a;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .header-left {
        flex: 1;
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: auto;
    }

    .login-btn {
        padding: 12px 28px;
        border: 3px solid #e21aff;
        background: linear-gradient(90deg, #833ab4 0%, #ff0099 100%);
        border-radius: 40px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 700;
        font-family: 'Press Start 2P', monospace;
        font-size: 10px;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: .5px;
        box-shadow: 0 0 8px #ff00ff, 0 0 18px #833ab4;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .login-btn:hover {
        box-shadow: 0 0 12px #ff00ff, 0 0 25px #833ab4;
        transform: translateY(-2px);
    }

    .logout-btn {
        background: #dc3545;
        border: 1px solid #dc3545;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .url-input-section {
            flex-direction: column;
        }
        
        .workflow-header {
            flex-direction: column;
            text-align: center;
        }
        
        .workflow-stats {
            flex-direction: column;
        }
        
        .deploy-section > div {
            flex-direction: column;
        }
    }
    </style>

    <script>
        // Global authentication variables - Set to default authenticated state for local development
        let currentUser = {
            id: 'local-user',
            email: 'local@development.com',
            user_metadata: {
                full_name: 'Local User',
                avatar_url: null
            }
        };
        let supabase_jwt = 'local-dev-token';
        
        // Global workflow variables
        let currentWorkflowData = null;
        let credentialFormInstance = null;

        // Notification function (missing from base template)
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideInRight 0.3s ease;
            `;
            
            switch(type) {
                case 'success':
                    notification.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    break;
                case 'info':
                    notification.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                    break;
                default:
                    notification.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // CSS animations for notifications
        if (!document.getElementById('notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // --- Authentication Logic (existing code continues...) ---
        // ... existing code ...

        /**
         * A wrapper for fetch that automatically adds the Supabase JWT and handles token refresh.
         */
        async function fetchWithAuth(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };
            
            // Get fresh token if available
            if (window.supabase && !supabase_jwt) {
                try {
                    const { data: { session } } = await window.supabase.auth.getSession();
                    if (session) {
                        supabase_jwt = session.access_token;
                        console.log('üîÑ Retrieved fresh token for request');
                    }
                } catch (error) {
                    console.warn('Failed to get fresh session:', error);
                }
            }
            
            if (supabase_jwt) {
                headers['Authorization'] = `Bearer ${supabase_jwt}`;
            }

            try {
                const response = await fetch(url, { ...options, headers });
                
                // Handle token expiration
                if (response.status === 401) {
                    const errorData = await response.json();
                    
                    // Check if it's a token expiration error
                    if (errorData.error && (
                        errorData.error.includes('expired') || 
                        errorData.error.includes('Token has expired') ||
                        errorData.error.includes('Invalid token')
                    )) {
                        console.warn('üîÑ Token expired, attempting to refresh...');
                        
                        // Try to refresh the session
                        if (window.supabase) {
                            try {
                                const { data: { session }, error } = await window.supabase.auth.refreshSession();
                                
                                if (error) {
                                    console.error('‚ùå Token refresh failed:', error);
                                    // Redirect to login if refresh fails
                                    showNotification('Session expired. Please log in again.', 'warning');
                                    await handleLogout();
                                    return response; // Return original 401 response
                                }
                                
                                if (session) {
                                    console.log('‚úÖ Token refreshed successfully');
                                    supabase_jwt = session.access_token;
                                    currentUser = session.user;
                                    
                                    // Retry the request with the new token
                                    const newHeaders = {
                                        ...headers,
                                        'Authorization': `Bearer ${supabase_jwt}`
                                    };
                                    
                                    console.log('üîÑ Retrying request with fresh token');
                                    return await fetch(url, { ...options, headers: newHeaders });
                                } else {
                                    console.error('‚ùå No session after refresh');
                                    showNotification('Session expired. Please log in again.', 'warning');
                                    await handleLogout();
                                    return response;
                                }
                            } catch (refreshError) {
                                console.error('‚ùå Error during token refresh:', refreshError);
                                showNotification('Session expired. Please log in again.', 'warning');
                                await handleLogout();
                                return response;
                            }
                        } else {
                            console.error('‚ùå Supabase client not available for token refresh');
                            showNotification('Session expired. Please log in again.', 'warning');
                            await handleLogout();
                            return response;
                        }
                    }
                }
                
                return response;
            } catch (fetchError) {
                console.error('‚ùå Fetch error:', fetchError);
                throw fetchError;
            }
        }

        // Authentication helper function
        function isUserAuthenticated() {
            // Always return true for local development
            const authenticated = true;
            
            // Update visual status indicator
            const authStatus = document.getElementById('authStatus');
            if (authStatus) {
                authStatus.style.color = authenticated ? '#10b981' : '#ef4444';
                authStatus.textContent = '‚óè';
                authStatus.title = authenticated ? 'Authenticated' : 'Not Authenticated';
            }
            
            return authenticated;
        }

        /**
         * This is the main entry point. It sets up the Supabase client and
         * listens for authentication state changes. This is the correct way
         * to handle logins with Supabase.
         */
        function initializeSupabaseAuth() {
            const supabaseUrl = 'https://upajkfvsfmrimhcimded.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwYWprZnZzZm1yaW1oY2ltZGVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0MDU1NzIsImV4cCI6MjA2NTk4MTU3Mn0.pQwTA65z2WpU8t6KRKTQfKzTHaQgKtJrW3MMcHZ-zuU';
            
            if (typeof window.supabase === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                script.onload = async () => {
                    window.supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey, {
                        auth: {
                            storage: window.localStorage,
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: true
                        }
                    });

                    // Handle OAuth redirect more robustly
                    const isAuthRedirect = window.location.hash && window.location.hash.includes('access_token');
                    if (isAuthRedirect) {
                        console.log('OAuth redirect detected, full hash:', window.location.hash);
                        showNotification('Processing authentication...', 'info');
                        
                        // Parse the hash parameters for debugging
                        const hashParams = new URLSearchParams(window.location.hash.substring(1));
                        const hashData = {
                            access_token: hashParams.get('access_token') ? 'present' : 'missing',
                            refresh_token: hashParams.get('refresh_token') ? 'present' : 'missing',
                            expires_in: hashParams.get('expires_in'),
                            token_type: hashParams.get('token_type'),
                            provider_token: hashParams.get('provider_token') ? 'present' : 'missing'
                        };
                        console.log('Hash parameters:', hashData);
                        
                        // Don't clean up URL yet - let Supabase process it first
                        // The auth state change listener will handle the success case
                        
                        // Set a flag to track this auth attempt
                        window.authInProgress = true;
                        
                        // Set a timeout to handle auth failure - reduced to 15 seconds with better fallback
                        setTimeout(() => {
                            if (window.authInProgress && !currentUser) {
                                console.error('Authentication timeout - no session created after 15 seconds');
                                console.log('Attempting to recover session...');
                                
                                // Try to recover session before showing error
                                window.supabase.auth.getSession().then(({ data: { session } }) => {
                                    if (session) {
                                        console.log('Session found during timeout recovery');
                                        currentUser = session.user;
                                        supabase_jwt = session.access_token;
                                        window.authInProgress = false;
                                        updateUIForAuthenticatedUser();
                                        syncUserWithBackend();
                                    } else {
                                        console.log('No session found during timeout recovery');
                                        showNotification('Authentication timeout. Please try signing in again.', 'error');
                                        window.authInProgress = false;
                                        window.history.replaceState(null, null, window.location.pathname);
                                        updateUIForGuestUser();
                                    }
                                }).catch((error) => {
                                    console.error('Error during timeout recovery:', error);
                                    showNotification('Authentication timeout. Please try signing in again.', 'error');
                                    window.authInProgress = false;
                                    window.history.replaceState(null, null, window.location.pathname);
                                    updateUIForGuestUser();
                                });
                            }
                        }, 15000);
                        
                        return; // Let the auth state change event handle the rest
                    }

                    // Check for existing session on page load (not during OAuth redirect)
                    if (!isAuthRedirect) {
                        try {
                            const { data: { session }, error } = await window.supabase.auth.getSession();
                            
                            if (error) {
                                console.error('Supabase getSession error:', error);
                            }
                            
                            if (session) {
                                console.log('Existing session restored:', session.user.email);
                                currentUser = session.user;
                                supabase_jwt = session.access_token;
                                updateUIForAuthenticatedUser();
                                await syncUserWithBackend();
                            } else {
                                updateUIForGuestUser();
                            }
                        } catch (error) {
                            console.error('Error during session check:', error);
                            updateUIForGuestUser();
                        }
                    }

                    // The onAuthStateChange listener is the key to fixing the login issue.
                    // It reliably fires whenever the user logs in, logs out, or the session is refreshed.
                    window.supabase.auth.onAuthStateChange(async (event, session) => {
                        console.log(`Supabase Auth Event: ${event}`, {
                            session: session ? 'present' : 'null',
                            user: session?.user?.email,
                            access_token: session?.access_token ? 'present' : 'missing'
                        });

                        if (event === 'SIGNED_IN') {
                            if (session) {
                                currentUser = session.user;
                                supabase_jwt = session.access_token;
                                
                                // Force immediate UI update
                                updateUIForAuthenticatedUser();
                                
                                // Close auth modal if it's open
                                try {
                                    hideModal('authModal');
                                } catch (e) {
                                    console.log('Modal close error (not critical):', e);
                                }
                                
                                // Sync with backend
                                await syncUserWithBackend();
                                
                                // Handle successful OAuth flow
                                if (window.authInProgress || window.location.hash.includes('access_token')) {
                                    window.authInProgress = false;
                                    // Clean up URL now that auth is successful
                                    if (window.location.hash) {
                                        console.log('Cleaning up OAuth callback URL...');
                                        window.history.replaceState(null, null, window.location.pathname);
                                        // Don't reload immediately - let the UI update first
                                        setTimeout(() => {
                                            console.log('OAuth flow complete, reloading for clean state...');
                                            window.location.reload();
                                        }, 2000);
                                    }
                                    showNotification(`Welcome back, ${session.user.user_metadata?.full_name || session.user.email}!`, 'success');
                                } else {
                                    // Direct login or session restoration
                                    showNotification(`Welcome, ${session.user.user_metadata?.full_name || session.user.email}!`, 'success');
                                    // Force UI update again after a short delay
                                    setTimeout(() => {
                                        updateUIForAuthenticatedUser();
                                    }, 200);
                                }
                            }
                        } else if (event === 'TOKEN_REFRESHED') {
                            if (session) {
                                // Update tokens when they're refreshed
                                currentUser = session.user;
                                supabase_jwt = session.access_token;
                                console.log('‚úÖ Token automatically refreshed for:', session.user.email);
                                
                                // Ensure UI remains in authenticated state
                                updateUIForAuthenticatedUser();
                            } else {
                                console.warn('‚ö†Ô∏è TOKEN_REFRESHED event but no session provided');
                            }
                        } else if (event === 'INITIAL_SESSION') {
                            if (session) {
                                currentUser = session.user;
                                supabase_jwt = session.access_token;
                                console.log('Initial session restored for:', session.user.email);
                                updateUIForAuthenticatedUser();
                                await syncUserWithBackend();
                                
                                // If this is an OAuth callback, clean it up
                                if (window.location.hash.includes('access_token') && !window.authInProgress) {
                                    console.log('Cleaning up OAuth callback from initial session...');
                                    setTimeout(() => {
                                        window.history.replaceState(null, null, window.location.pathname);
                                    }, 1000);
                                }
                            } else {
                                console.log('No initial session found');
                                updateUIForGuestUser();
                            }
                        } else if (event === 'SIGNED_OUT') {
                            currentUser = null;
                            supabase_jwt = null;
                            console.log('Auth state change - signed out');
                            
                            // Force immediate UI update for logout
                            updateUIForGuestUser();
                            
                            // Clear any workflow data since user is logged out
                            currentWorkflowData = null;
                            
                            // Hide workflow preview and credential forms
                            setTimeout(() => {
                                const workflowPreview = document.getElementById('workflowPreview');
                                const credentialForm = document.getElementById('credentialFormContainer');
                                if (workflowPreview) workflowPreview.style.display = 'none';
                                if (credentialForm) credentialForm.style.display = 'none';
                                
                                // Force UI update again
                                updateUIForGuestUser();
                            }, 100);
                        }
                    });
                };
                document.head.appendChild(script);
            }
        }

        async function syncUserWithBackend() {
            if (!currentUser || !supabase_jwt) {
                console.log('Skipping backend sync - missing user or JWT');
                return;
            }
            
            try {
                console.log('Syncing user with backend...', currentUser.email);
                
                // First try to get current user (this will create profile if needed)
                const userResponse = await fetchWithAuth('/api/auth/user', { method: 'GET' });
                const userData = await userResponse.json();
                
                if (userData.authenticated) {
                    console.log('User profile synced with backend:', userData.user.email);
                    
                    // Clear auth in progress flag since sync was successful
                    if (window.authInProgress) {
                        window.authInProgress = false;
                        console.log('Auth progress flag cleared after successful sync');
                    }
                } else {
                    console.log('User not authenticated in backend, attempting login sync...');
                    
                    // If user check failed, try the login endpoint to create/sync profile
                    const loginResponse = await fetchWithAuth('/api/auth/login', { method: 'POST' });
                    const loginData = await loginResponse.json();
                    
                    if (loginData.success) {
                        console.log('User profile created/synced via login endpoint');
                        
                        // Clear auth in progress flag since sync was successful
                        if (window.authInProgress) {
                            window.authInProgress = false;
                            console.log('Auth progress flag cleared after successful login sync');
                        }
                    } else {
                        console.error('Failed to sync user profile with backend:', loginData.error);
                    }
                }
            } catch (e) {
                console.error('Error syncing user profile:', e);
                
                // Don't leave auth in progress indefinitely on error
                if (window.authInProgress) {
                    console.log('Clearing auth progress flag due to sync error');
                    setTimeout(() => {
                        if (window.authInProgress) {
                            window.authInProgress = false;
                        }
                    }, 5000); // Clear after 5 seconds on error
                }
            }
        }

        // Ultimate fallback: Force UI state check periodically
        function forceUIStateCheck() {
            // Defensive check for undefined variables
            const isLoggedIn = !!(currentUser && supabase_jwt);
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            
            if (loginBtn && userInfo) {
                const loginVisible = loginBtn.style.display !== 'none' && loginBtn.style.visibility !== 'hidden';
                const userInfoVisible = userInfo.style.display !== 'none' && userInfo.style.visibility !== 'hidden';
                
                // Check if UI state matches auth state
                if (isLoggedIn && loginVisible) {
                    console.log('UI state mismatch detected - user logged in but login button visible, fixing...');
                    updateUIForAuthenticatedUser();
                } else if (!isLoggedIn && userInfoVisible) {
                    console.log('UI state mismatch detected - user logged out but user info visible, fixing...');
                    updateUIForGuestUser();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded - initializing local development mode');
            
            // Set up authenticated UI immediately for local development
            updateUIForAuthenticatedUser();
            
            // Load user content
            setTimeout(() => {
                if (isUserAuthenticated()) {
                    loadUserUploadedWorkflows();
                    loadMCPServers();
                }
            }, 1000);
        });

        function updateUIForAuthenticatedUser() {
            console.log('Updating UI for authenticated user:', currentUser?.email);
            
            // Force immediate DOM update with multiple attempts
            const updateAttempt = () => {
                const loginBtn = document.getElementById('loginBtn');
                const userInfo = document.getElementById('userInfo');
                const userName = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');

                if (loginBtn && userInfo && userName && currentUser) {
                    // Force hide login button with multiple CSS properties
                    loginBtn.style.display = 'none';
                    loginBtn.style.visibility = 'hidden';
                    loginBtn.classList.add('hidden');
                    
                    // Force show user info with multiple CSS properties
                    userInfo.style.display = 'flex';
                    userInfo.style.visibility = 'visible';
                    userInfo.classList.remove('hidden');
                    
                    userName.textContent = currentUser.user_metadata?.full_name || currentUser.email;
                    
                    if (userAvatar && currentUser.user_metadata?.avatar_url) {
                        userAvatar.src = currentUser.user_metadata.avatar_url;
                    } else if (userAvatar) {
                        // Use a data URL for default avatar to avoid 404 errors
                        userAvatar.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiM2NjdlZWEiLz4KPHRleHQgeD0iMTYiIHk9IjIwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5VPC90ZXh0Pgo8L3N2Zz4K';
                    }
                    
                    userName.title = `Authenticated as ${currentUser.email}\nJWT: ${supabase_jwt ? 'Present' : 'Missing'}`;
                    
                    console.log('UI updated - Login button hidden, user info shown');
                    return true;
                } else {
                    console.error('Missing UI elements or currentUser:', {
                        loginBtn: !!loginBtn,
                        userInfo: !!userInfo,
                        userName: !!userName,
                        currentUser: !!currentUser
                    });
                    return false;
                }
            };

            // Try immediate update
            if (!updateAttempt()) {
                // If failed, retry after DOM is ready
                setTimeout(updateAttempt, 100);
                setTimeout(updateAttempt, 500);
                setTimeout(updateAttempt, 1000);
            }
            
            // When the user logs in, check which credentials they have saved.
            showAvailableCredentials();
            
            // Load user workflows and MCP servers now that authentication is confirmed
            setTimeout(() => {
                loadUserUploadedWorkflows();
                loadMCPServers();
            }, 500);
        }

        function updateUIForGuestUser() {
            console.log('Updating UI for guest user (logged out)');
            
            // Force immediate DOM update with multiple attempts
            const updateAttempt = () => {
                const loginBtn = document.getElementById('loginBtn');
                const userInfo = document.getElementById('userInfo');

                if (loginBtn && userInfo) {
                    // Force show login button with multiple CSS properties
                    loginBtn.style.display = 'block';
                    loginBtn.style.visibility = 'visible';
                    loginBtn.classList.remove('hidden');
                    
                    // Force hide user info with multiple CSS properties
                    userInfo.style.display = 'none';
                    userInfo.style.visibility = 'hidden';
                    userInfo.classList.add('hidden');
                    
                    console.log('UI updated - Login button shown, user info hidden');
                    return true;
                } else {
                    console.error('Missing UI elements for guest update:', {
                        loginBtn: !!loginBtn,
                        userInfo: !!userInfo
                    });
                    return false;
                }
            };

            // Try immediate update
            if (!updateAttempt()) {
                // If failed, retry after DOM is ready
                setTimeout(updateAttempt, 100);
                setTimeout(updateAttempt, 500);
                setTimeout(updateAttempt, 1000);
            }

            // No need to hide load buttons since they no longer exist
        }

        function showAuthModal() {
            // Disabled for local development
            console.log('Authentication modal disabled for local development');
        }

        function authenticateWith(provider) {
            // Disabled for local development
            console.log('OAuth authentication disabled for local development');
            showNotification('Already authenticated in local development mode', 'info');
        }

        async function logout() {
            // Disabled for local development
            console.log('Logout disabled for local development');
            showNotification('Logout disabled in local development mode', 'info');
        }

        // Alias for backward compatibility and fetchWithAuth function
        async function handleLogout() {
            return await logout();
        }


        function showAvailableCredentials() {
            if (!currentUser || !currentWorkflowData) return;
            // Delay slightly to ensure the credential form is rendered, then auto-load
            setTimeout(() => {
                autoLoadUserCredentials();
            }, 500);
        }

        function importWorkflowFromUrl() {
            if (!isUserAuthenticated()) {
                showNotification('Please sign in to import N8N templates', 'error');
                return;
            }

            const urlInput = document.getElementById('templateUrlInput');
            const url = urlInput.value.trim();
            if (!url) {
                showNotification('Please enter a workflow URL', 'error');
                return;
            }

            const templateId = extractTemplateId(url);
            if (!templateId) {
                showNotification('Invalid N8N workflow URL format', 'error');
                return;
            }

            showLoading();

            fetchWithAuth('/api/import-n8n-template-enhanced', {
                method: 'POST',
                body: JSON.stringify({
                    template_id: templateId,
                    template_url: url
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                                            console.log('Workflow data received:', data);
                    
                    showWorkflowConfiguration(data);
                    currentWorkflowData = data;
                    showNotification(data.cached ? 'Workflow loaded from cache' : 'Workflow imported successfully!', 'success');
                } else {
                    showNotification('Error importing workflow: ' + data.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                showNotification('Network error: ' + error.message, 'error');
            });
        }

        function extractTemplateId(url) {
            // Extract template ID from N8N workflow URLs
            const patterns = [
                /workflows\/(\d+)/,           // https://n8n.io/workflows/5048
                /templates\/(\d+)/,          // https://api.n8n.io/api/workflows/templates/5048
                /workflow\/(\d+)/            // Alternative formats
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        // Credential persistence disabled ‚Äì accept in-memory credentials only
        function saveIndividualCredential(serviceName) {
            showNotification('Credentials are used only for this session and are not stored.', 'info');
        }

        // Missing utility functions
        function showLoading() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'block';
        }

        function hideLoading() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'none';
        }

        function showWorkflowConfiguration(data) {
            const config = document.getElementById('workflowConfiguration');
            if (config) {
                config.style.display = 'block';
                
                // Store workflow data globally for deployment
                window.currentWorkflowData = data;
                // Store workflow data globally for deployment
                
                // Workflow data validation
                if (data.original_workflow_json && data.original_workflow_json.nodes) {
                    // Use original_workflow_json (has actual nodes)
                }
                if (data.workflow_json && data.workflow_json.nodes) {
                    // Use workflow_json (has actual nodes)
                }
                if (data.original_workflow && data.original_workflow.nodes) {
                    // Use original_workflow (has actual nodes)
                }
                
                // Process workflow configuration data
                
                // Update workflow details with multiple fallback options
                const title = document.getElementById('workflowTitle');
                const description = document.getElementById('workflowDescription');
                const nodeCount = document.getElementById('nodeCount');
                const credentialCount = document.getElementById('credentialCount');
                
                if (title) {
                    title.textContent = data.title || data.template_name || data.workflow_name || data.name || data.workflow_info?.name || 'Untitled Workflow';
                }
                
                if (description) {
                    description.textContent = data.description || data.workflow_description || 
                                           (data.workflow_info?.description) || 'No description available';
                }
                
                if (nodeCount) {
                    const nodes = data.node_count || 
                                 data.nodes?.length || 
                                 (data.workflow_data?.nodes ? data.workflow_data.nodes.length : 0) ||
                                 (data.workflow_info?.total_nodes) ||
                                 0;
                    nodeCount.textContent = nodes;
                }
                
                if (credentialCount) {
                    const credentials = data.credential_count || 
                                       data.credentials?.length || 
                                       (data.form_config?.credentials ? data.form_config.credentials.length : 0) ||
                                       (data.workflow_info?.required_credentials) ||
                                       0;
                    credentialCount.textContent = credentials;
                }

                // Show credential configuration directly
                showCredentialConfigurationInline(data);
                
                // Scroll to configuration
                config.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function showCredentialConfigurationInline(data) {
            const container = document.getElementById('credentialFormContainer');
            
            if (!container) {
                console.error('üîß CRED-FORM: Credential form container not found');
                return;
            }
            
            //console.log('üîß CRED-FORM: Input data:', data);
            
            // Enhanced credential detection - handle multiple data formats
            let credentialsToProcess = [];
            
            // Method 1: Standard form_config.credentials (from API parsing)
            if (data && data.form_config && data.form_config.credentials) {
                //console.log('üîß CRED-FORM: Using form_config.credentials');
                credentialsToProcess = data.form_config.credentials;
            }
            // Method 2: Simple credentials_required array (from database)
            else if (data && data.credentials_required && Array.isArray(data.credentials_required)) {
                //console.log('üîß CRED-FORM: Converting credentials_required array to credential objects');
                credentialsToProcess = data.credentials_required.map(serviceName => ({
                    service_name: serviceName,
                    description: `Configure your ${serviceName} credentials`,
                    fields: [
                        {
                            name: 'api_key',
                            display_name: 'API Key',
                            type: 'password',
                            required: true,
                            placeholder: `Enter your ${serviceName} API key`,
                            help_text: `Your ${serviceName} API key for authentication`
                        }
                    ]
                }));
            }
            // Method 3: Check currentWorkflowData for credentials_required
            else if (currentWorkflowData && currentWorkflowData.credentials_required) {
                console.log('üîß CRED-FORM: Using currentWorkflowData.credentials_required');
                const credsRequired = Array.isArray(currentWorkflowData.credentials_required) 
                    ? currentWorkflowData.credentials_required 
                    : [currentWorkflowData.credentials_required];
                    
                credentialsToProcess = credsRequired.map(serviceName => ({
                    service_name: serviceName,
                    description: `Configure your ${serviceName} credentials`,
                    fields: [
                        {
                            name: 'api_key',
                            display_name: 'API Key', 
                            type: 'password',
                            required: true,
                            placeholder: `Enter your ${serviceName} API key`,
                            help_text: `Your ${serviceName} API key for authentication`
                        }
                    ]
                }));
            }
            
            //console.log('üîß CRED-FORM: Final credentials to process:', credentialsToProcess);
            
            if (!credentialsToProcess || credentialsToProcess.length === 0) {
                // No credentials required for this workflow
                container.innerHTML = '<p style="color: #8a8aa0; text-align: center; padding: 20px;">This workflow does not require any credential configuration.</p>';
                //console.log('üîß CRED-FORM: No credentials required');
                return;
            }
            
            // Generate the credential form HTML for inline display
            let formHTML = '';
            
            credentialsToProcess.forEach((cred, index) => {
                //console.log(`üîß CRED-FORM: Processing credential ${index + 1}:`, cred);
                
                formHTML += `
                    <div class="credential-section" style="margin-bottom: 30px;" data-service-section="${cred.service_name}">
                        <h4 style="color: #e21aff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-plug"></i>
                            ${cred.service_name} Configuration
                        </h4>
                        <p style="color: #8a8aa0; margin-bottom: 20px;">${cred.description || `Configure your ${cred.service_name} credentials`}</p>
                        
                        <div style="background: rgba(26, 26, 46, 0.6); border: 2px solid #4e4e7a; border-radius: 15px; padding: 25px;">
                `;
                
                // Add form fields for this service
                cred.fields.forEach(field => {
                    const fieldType = field.type === 'password' ? 'password' : 'text';
                    const isRequired = field.required ? 'required' : '';
                    const placeholder = field.placeholder || `Enter your ${field.name}`;
                    
                   //console.log(`üîß CRED-FORM: Adding field ${field.name} for ${cred.service_name}`);
                    
                    formHTML += `
                        <div style="margin-bottom: 20px;">
                            <label style="color: #e5e5e5; display: block; margin-bottom: 8px; font-weight: 500;">
                                ${field.display_name}
                                ${field.required ? '<span style="color: #e21aff;">*</span>' : ''}
                            </label>
                            <input 
                                type="${fieldType}" 
                                name="${field.name}" 
                                data-service="${cred.service_name}"
                                data-field-name="${field.name}"
                                placeholder="${placeholder}"
                                ${isRequired}
                                style="width: 100%; padding: 12px 15px; background: #1a1a2e; border: 2px solid #4e4e7a; border-radius: 8px; color: #e5e5e5; font-size: 14px; transition: border-color 0.3s;"
                                onfocus="this.style.borderColor='#e21aff'"
                                onblur="this.style.borderColor='#4e4e7a'"
                            >
                            ${field.help_text ? `<small style="color: #8a8aa0; font-size: 12px; margin-top: 5px; display: block;">${field.help_text}</small>` : ''}
                        </div>
                    `;
                });
                
                formHTML += `
                            <div class="credential-actions">
                                <!-- Save credentials disabled -->
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Set the form content
            container.innerHTML = formHTML;
            //console.log('üîß CRED-FORM: Credential form HTML generated and inserted');
            
            // Verify that inputs were created properly
            setTimeout(() => {
                const createdInputs = container.querySelectorAll('input[data-service]');
                //console.log(`üîß CRED-FORM: Created ${createdInputs.length} credential inputs:`, 
                    //Array.from(createdInputs).map(input => `${input.getAttribute('data-service')}.${input.name}`));
            }, 100);
            
            // Auto-loading stored credentials removed ‚Äì none are persisted anymore.
        }

        function showJsonEditor() {
            showModal('jsonEditorModal');
        }

        function validateJson() {
            const editor = document.getElementById('jsonEditor');
            if (!editor) return;
            
            try {
                JSON.parse(editor.value);
                showNotification('JSON is valid!', 'success');
            } catch (e) {
                showNotification('Invalid JSON: ' + e.message, 'error');
            }
        }

        function formatJson() {
            const editor = document.getElementById('jsonEditor');
            if (!editor) return;
            
            try {
                const parsed = JSON.parse(editor.value);
                editor.value = JSON.stringify(parsed, null, 2);
                showNotification('JSON formatted successfully!', 'success');
            } catch (e) {
                showNotification('Cannot format invalid JSON', 'error');
            }
        }

        function validateAndUploadFile() {
            const workflowNameInput = document.getElementById('userWorkflowName');
            const workflowName = workflowNameInput ? workflowNameInput.value.trim() : '';
            
            if (!workflowName) {
                showNotification('Please enter a workflow name', 'error');
                workflowNameInput?.focus();
                return;
            }
            
            // Trigger file selection
            document.getElementById('workflowFile').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                showNotification('Please select a JSON file', 'error');
                return;
            }
            
            const workflowNameInput = document.getElementById('userWorkflowName');
            const workflowName = workflowNameInput ? workflowNameInput.value.trim() : '';
            
            if (!workflowName) {
                showNotification('Please enter a workflow name first', 'error');
                workflowNameInput?.focus();
                return;
            }
            
            showLoading();
            showNotification('Processing workflow file...', 'info');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('manual_workflow_name', workflowName);
            
            // Upload workflow file
            
            fetch('/api/parse-workflow-file', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('File upload response status:', response.status);
                console.log('File upload response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.log('Error response body:', text);
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                                            console.log('File upload successful, workflow data:', data);
                    
                    // IMPORTANT: We need to preserve the original uploaded workflow JSON
                    // The backend might not return the actual workflow JSON, just metadata
                    const uploadedFileInput = document.getElementById('workflowFile');
                    if (!data.original_workflow_json && uploadedFileInput && uploadedFileInput.files && uploadedFileInput.files[0]) {
                        // Read original file content for workflow JSON preservation
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const originalWorkflowJson = JSON.parse(e.target.result);
                                data.original_workflow_json = originalWorkflowJson;
                                
                                showWorkflowConfiguration(data);
                                currentWorkflowData = data;
                            } catch (error) {
                                console.error('‚ùå Error preserving original workflow JSON:', error);
                                showWorkflowConfiguration(data);
                                currentWorkflowData = data;
                            }
                        };
                        reader.readAsText(uploadedFileInput.files[0]);
                    } else {
                        showWorkflowConfiguration(data);
                        currentWorkflowData = data;
                    }
                    
                    const workflowName = data.manual_workflow_name || data.workflow_info.name;
                    showNotification(`Workflow "${workflowName}" loaded successfully!`, 'success');
                    
                    // Clear the form after successful upload
                    const fileInput = document.getElementById('workflowFile');
                    const nameInput = document.getElementById('userWorkflowName');
                    if (fileInput) fileInput.value = '';
                    if (nameInput) nameInput.value = '';
                    
                    // Debug: Log the is_user_upload flag
                                            // File upload type determination
                } else {
                    showNotification('Error processing workflow file: ' + data.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('File upload error:', error);
                showNotification('Error uploading file: ' + error.message, 'error');
            });
        }

        function processJsonFromEditor() {
            const editor = document.getElementById('jsonEditor');
            if (!editor || !editor.value.trim()) {
                showNotification('Please enter JSON content', 'error');
                return;
            }
            
            // Get manual workflow name
            const workflowNameInput = document.getElementById('jsonWorkflowName');
            const workflowName = workflowNameInput ? workflowNameInput.value.trim() : '';
            
            if (!workflowName) {
                showNotification('Please enter a workflow name first', 'error');
                workflowNameInput?.focus();
                return;
            }
            
            // Validate JSON before sending
            let workflowJson;
            try {
                workflowJson = JSON.parse(editor.value);
            } catch (parseError) {
                showNotification('Invalid JSON format: ' + parseError.message, 'error');
                return;
            }
            
            hideModal('jsonEditorModal');
            showLoading();
            
                            // Send workflow JSON to parse endpoint
            
            fetch('/api/parse-workflow', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    workflow_json: workflowJson,
                    manual_workflow_name: workflowName
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                console.log('Response content-type:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    // Try to get the actual response text for debugging
                    return response.text().then(text => {
                        console.log('Error response body:', text);
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${text.substring(0, 200)}`);
                    });
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.log('Non-JSON response body:', text.substring(0, 500));
                        throw new Error(`Expected JSON response but got ${contentType || 'unknown'} - ${text.substring(0, 100)}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                    // Store original workflow data for deployment
                    data.original_workflow = workflowJson;
                    // CRITICAL: Also store as original_workflow_json for deployment
                    data.original_workflow_json = workflowJson;
                    // JSON paste processing complete
                    
                    showWorkflowConfiguration(data);
                    currentWorkflowData = data;
                    
                    const displayName = data.manual_workflow_name || data.workflow_info.name;
                    showNotification(`Workflow "${displayName}" parsed successfully!`, 'success');
                    
                    // Clear the form after successful processing
                    const editor = document.getElementById('jsonEditor');
                    const nameInput = document.getElementById('jsonWorkflowName');
                    if (editor) editor.value = '';
                    if (nameInput) nameInput.value = '';
                    
                    // Debug: Log the manual workflow name
                    console.log('Manual workflow name from JSON paste:', data.manual_workflow_name);
                } else {
                    showNotification('Error parsing workflow: ' + data.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Processing error:', error);
                if (error.message.includes('Unexpected token')) {
                    showNotification('Server returned invalid response. Please check server logs.', 'error');
                } else {
                    showNotification('Network error: ' + error.message, 'error');
                }
            });
        }

        function showCredentialForm() {
            const container = document.getElementById('credentialFormContainer');
            const formDiv = document.getElementById('credentialForm');
            
            if (!container || !formDiv) {
                showNotification('Credential form not found', 'error');
                return;
            }
            
            if (!currentWorkflowData || !currentWorkflowData.form_config || !currentWorkflowData.form_config.credentials) {
                showNotification('No workflow data available. Please import a workflow first.', 'error');
                return;
            }
            
            // Generate the credential form HTML
            let formHTML = '';
            const credentials = currentWorkflowData.form_config.credentials;
            
            credentials.forEach((cred, index) => {
                formHTML += `
                    <div class="credential-section" style="margin-bottom: 30px;">
                        <h4 style="color: #e21aff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-plug"></i>
                            ${cred.service_name} Configuration
                        </h4>
                        <p style="color: #8a8aa0; margin-bottom: 20px;">${cred.description || `Configure your ${cred.service_name} credentials`}</p>
                        
                        <div style="background: rgba(26, 26, 46, 0.6); border: 2px solid #4e4e7a; border-radius: 15px; padding: 25px;">
                `;
                
                // Add form fields for this service
                cred.fields.forEach(field => {
                    const fieldType = field.type === 'password' ? 'password' : 'text';
                    const isRequired = field.required ? 'required' : '';
                    const placeholder = field.placeholder || `Enter your ${field.name}`;
                    
                    formHTML += `
                        <div style="margin-bottom: 20px;">
                            <label style="color: #e5e5e5; display: block; margin-bottom: 8px; font-weight: 500;">
                                ${field.display_name}
                                ${field.required ? '<span style="color: #e21aff;">*</span>' : ''}
                            </label>
                            <input 
                                type="${fieldType}" 
                                name="${field.name}" 
                                data-service="${cred.service_name}"
                                placeholder="${placeholder}"
                                ${isRequired}
                                style="width: 100%; padding: 12px 15px; background: #1a1a2e; border: 2px solid #4e4e7a; border-radius: 8px; color: #e5e5e5; font-size: 14px; transition: border-color 0.3s;"
                                onfocus="this.style.borderColor='#e21aff'"
                                onblur="this.style.borderColor='#4e4e7a'"
                            >
                            ${field.help_text ? `<small style="color: #8a8aa0; font-size: 12px; margin-top: 5px; display: block;">${field.help_text}</small>` : ''}
                        </div>
                    `;
                });
                
                formHTML += `
                            <div class="credential-actions">
                                <!-- Save credentials disabled -->
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add overall actions
            formHTML += `
                <div style="text-align: center; margin-top: 40px; padding-top: 30px; border-top: 2px solid #4e4e7a;">

                </div>
            `;
            
            // Set the form content and show the container
            formDiv.innerHTML = formHTML;
            container.style.display = 'block';
            
            // Scroll to the credential form
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Auto-loading stored credentials removed ‚Äì none are persisted anymore.
        }

        function cleanWorkflowCredentials(workflowJson) {
            // Create a deep copy of the workflow JSON to avoid modifying the original
            const cleanedWorkflow = JSON.parse(JSON.stringify(workflowJson));
            
            if (cleanedWorkflow.nodes && Array.isArray(cleanedWorkflow.nodes)) {
                cleanedWorkflow.nodes.forEach(node => {
                    // Remove any credential references or credential data
                    if (node.credentials) {
                        delete node.credentials;
                    }
                    
                    // Clear any sensitive parameters that might contain credentials
                    if (node.parameters) {
                        // Common credential fields to clear
                        const credentialFields = [
                            'authentication', 'credentials', 'credential', 'auth',
                            'apiKey', 'api_key', 'token', 'accessToken', 'access_token',
                            'secretKey', 'secret_key', 'password', 'username', 'clientId',
                            'clientSecret', 'bearer', 'oauth', 'webhook_url'
                        ];
                        
                        credentialFields.forEach(field => {
                            if (node.parameters[field] !== undefined) {
                                if (typeof node.parameters[field] === 'string') {
                                    node.parameters[field] = '';
                                } else if (typeof node.parameters[field] === 'object') {
                                    node.parameters[field] = {};
                                }
                            }
                        });
                    }
                });
            }
            
            return cleanedWorkflow;
        }



        function checkForCredentials(workflowData) {
            const credentialLocations = [];
            const sensitiveFields = [
                'credentials', 'credential', 'auth', 'authentication',
                'apiKey', 'api_key', 'token', 'accessToken', 'access_token',
                'secretKey', 'secret_key', 'password', 'username', 'clientId',
                'clientSecret', 'bearer', 'oauth', 'webhook_url'
            ];

            function searchObject(obj, path = '') {
                if (typeof obj !== 'object' || obj === null) return;

                if (Array.isArray(obj)) {
                    obj.forEach((item, index) => {
                        searchObject(item, `${path}[${index}]`);
                    });
                } else {
                    Object.keys(obj).forEach(key => {
                        const currentPath = path ? `${path}.${key}` : key;
                        
                        // Check if this key is a sensitive field and has a non-empty value
                        if (sensitiveFields.includes(key.toLowerCase())) {
                            const value = obj[key];
                            if (value && value !== '' && value !== '{}' && value !== null) {
                                credentialLocations.push({
                                    path: currentPath,
                                    key: key,
                                    valueType: typeof value,
                                    hasValue: true
                                });
                            }
                        }
                        
                        // Recursively search nested objects
                        if (typeof obj[key] === 'object') {
                            searchObject(obj[key], currentPath);
                        }
                    });
                }
            }

            searchObject(workflowData);

            return {
                found: credentialLocations.length > 0,
                locations: credentialLocations
            };
        }

        function importTemplate(templateId) {
            const urlInput = document.getElementById('templateUrlInput');
            if (urlInput) {
                urlInput.value = `https://n8n.io/workflows/${templateId}`;
                importWorkflowFromUrl();
            }
        }

        function showComingSoon() {
            showNotification('This template is coming soon!', 'info');
        }

        function getCredentialsForService(serviceName) {
            // Try multiple selectors to find inputs for this service
            const selectors = [
                `input[data-service="${serviceName}"]`,
                `#credentialFormContainer input[data-service="${serviceName}"]`,
                `[data-service-section="${serviceName}"] input[data-service="${serviceName}"]`
            ];
            
            let inputs = [];
            for (const selector of selectors) {
                const found = document.querySelectorAll(selector);
                if (found.length > 0) {
                    inputs = Array.from(found);
                    console.log(`üîç GET-CREDS: Found ${found.length} inputs for "${serviceName}" using selector: ${selector}`);
                    break;
                }
            }
            
            console.log(`üîç GET-CREDS: Looking for credentials for service "${serviceName}", found ${inputs.length} inputs total`);
            
            const credentials = {};
            
            inputs.forEach((input, index) => {
                const fieldName = input.name || input.getAttribute('data-field-name');
                const value = input.value ? input.value.trim() : '';
                console.log(`üîç GET-CREDS: Input ${index + 1} - ${serviceName}.${fieldName} = "${value ? '***' : 'EMPTY'}" (element:`, input, ')');
                
                if (fieldName && value) {
                    credentials[fieldName] = value;
                }
            });
            
            console.log(`üîç GET-CREDS: Returning ${Object.keys(credentials).length} credentials for ${serviceName}:`, Object.keys(credentials));
            return credentials;
        }



        function checkAndOfferWorkflowDeployment() {
            if (!currentWorkflowData || !currentWorkflowData.form_config || !currentWorkflowData.form_config.credentials) {
                return;
            }

            // Prevent duplicate modals - check if modal already exists
            const existingModal = document.querySelector('.unified-deployment-modal');
            if (existingModal) {
                console.log('Deployment modal already exists, skipping duplicate creation');
                return;
            }

            // Check if all required credentials are saved
            const requiredServices = currentWorkflowData.form_config.credentials.map(cred => cred.service_name);
            let allCredentialsSaved = true;
            
            // Check each required service
            for (const serviceName of requiredServices) {
                const credentials = getCredentialsForService(serviceName);
                if (!credentials || Object.keys(credentials).length === 0) {
                    allCredentialsSaved = false;
                    break;
                }
            }

            if (allCredentialsSaved) {
                console.log('All credentials configured, showing deployment modal');
                // All credentials are configured, show deployment option
                showWorkflowDeploymentOption();
            } else {
                console.log('Not all credentials configured yet:', {
                    required: requiredServices,
                    missing: requiredServices.filter(service => {
                        const creds = getCredentialsForService(service);
                        return !creds || Object.keys(creds).length === 0;
                    })
                });
            }
        }

        function showWorkflowDeploymentOption() {
            // Directly deploy without showing popup
            deployWorkflowToN8N();
        }

        function dismissDeploymentNotification() {
            // Updated to work with new unified modal system
            closeUnifiedModal();
        }

        function deployWorkflowToN8N() {
            // Start deployment process
            
            if (!currentWorkflowData) {
                showNotification('No workflow loaded. Please import or select a workflow first.', 'error');
                return;
            }

            if (!isUserAuthenticated()) {
                showNotification('Please sign in to deploy workflows', 'error');
                return;
            }

            // Use the template_id from the loaded workflow data
            let templateId = currentWorkflowData.template_id;
   
            // If no template_id, check if this is a new workflow that needs to be saved first
            if (!templateId) {
                console.log('‚ö†Ô∏è DEPLOYMENT: No template_id found, attempting direct deployment with workflow data');
                
                // For workflows without template_id (new uploads, JSON pastes), 
                // we need to deploy directly with the workflow JSON and credentials
                const workflowJson = currentWorkflowData.workflow_json || currentWorkflowData.original_workflow;
                
                if (!workflowJson) {
                    console.error('‚ùå DEPLOYMENT: No workflow JSON found either');
                    showNotification('No workflow data found for deployment. Please reload the workflow.', 'error');
                    return;
                }
                
                // Collect configured credentials from form inputs
                const credentials = {};
                const credentialInputs = document.querySelectorAll('#credentialFormContainer input[data-service]');
                
                credentialInputs.forEach(input => {
                    const serviceName = input.getAttribute('data-service');
                    const fieldName = input.name;
                    const value = input.value.trim();
                    
                    if (value) {
                        if (!credentials[serviceName]) {
                            credentials[serviceName] = {};
                        }
                        credentials[serviceName][fieldName] = value;
                    }
                });
                
                // Direct deployment payload with workflow JSON
                const deploymentPayload = {
                    workflow_json: workflowJson,
                    workflow_name: currentWorkflowData.workflow_info?.name || currentWorkflowData.workflow_name,
                    user_credentials: credentials
                };
                
                // Deploy with workflow JSON directly
                
                showNotification('Deploying workflow directly to your N8N workspace...', 'info');
                
                fetchWithAuth('/api/deploy-workflow-to-n8n', {
                    method: 'POST',
                    body: JSON.stringify(deploymentPayload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Workflow deployed successfully! üöÄ`, 'success');
                        showDeploymentSuccess(data);
                    } else {
                        if (data.error && data.error.includes('N8N instance configuration missing')) {
                            showUnifiedDeploymentModal('config_missing');
                        } else {
                            showNotification(`Deployment failed: ${data.error}`, 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Deployment error:', error);
                    showNotification(`Network error during deployment: ${error.message}`, 'error');
                });
                
                return;
            }

            showNotification('Deploying workflow to your N8N workspace...', 'info');
        }

        // Unified deployment modal function
        function showUnifiedDeploymentModal(type, data = null) {
            // Remove any existing modals first
            const existingModals = document.querySelectorAll('.unified-deployment-modal, .deployment-success-modal, .deployment-notification');
            existingModals.forEach(modal => modal.remove());
            
            const modal = document.createElement('div');
            modal.className = 'unified-deployment-modal';
            
            let modalContent = '';
            
            switch(type) {
                case 'config_missing':
                    modalContent = `
                        <div class="modal-overlay" onclick="closeUnifiedModal()" style="
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; 
                            justify-content: center; z-index: 10000;">
                            <div class="modal-content" onclick="event.stopPropagation()" style="
                                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                                border: 2px solid #dc3545; border-radius: 20px; padding: 30px;
                                max-width: 500px; width: 90%; text-align: center; position: relative;
                                font-family: 'Press Start 2P', monospace;">
                                
                                <button onclick="closeUnifiedModal()" style="
                                    position: absolute; top: 15px; right: 15px; background: none;
                                    border: none; color: #8a8aa0; font-size: 16px; cursor: pointer;
                                    font-family: 'Press Start 2P', monospace;">&times;</button>
                                
                                <div style="color: #dc3545; font-size: 3em; margin-bottom: 20px;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                
                                <h2 style="color: #fff; margin-bottom: 15px; font-size: 0.8em;">N8N CONFIG MISSING</h2>
                                
                                <p style="color: #e5e5e5; margin-bottom: 25px; font-size: 0.6em; line-height: 1.5;">
                                    DEPLOYMENT FAILED: N8N INSTANCE CONFIGURATION MISSING.<br/>
                                    PLEASE CONFIGURE YOUR N8N INSTANCE URL AND API KEY IN YOUR PROFILE.
                                </p>
                                
                                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                    <button onclick="openUserProfile(); closeUnifiedModal();" style="
                                        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                                        color: white; border: none; padding: 12px 20px; border-radius: 8px;
                                        font-weight: bold; cursor: pointer; transition: all 0.3s;
                                        font-family: 'Press Start 2P', monospace; font-size: 0.5em;">
                                        CONFIGURE N8N
                                    </button>
                                    <button onclick="closeUnifiedModal()" style="
                                        background: #6c757d; color: white; border: none; padding: 12px 20px; 
                                        border-radius: 8px; cursor: pointer; font-family: 'Press Start 2P', monospace;
                                        font-size: 0.5em;">
                                        CLOSE
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'success':
                    modalContent = `
                        <div class="modal-overlay" onclick="closeUnifiedModal()" style="
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; 
                            justify-content: center; z-index: 10000;">
                            <div class="modal-content" onclick="event.stopPropagation()" style="
                                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                                border: 2px solid #00c851; border-radius: 20px; padding: 30px;
                                max-width: 500px; width: 90%; text-align: center; position: relative;
                                font-family: 'Press Start 2P', monospace;">
                                
                                <button onclick="closeUnifiedModal()" style="
                                    position: absolute; top: 15px; right: 15px; background: none;
                                    border: none; color: #8a8aa0; font-size: 16px; cursor: pointer;
                                    font-family: 'Press Start 2P', monospace;">&times;</button>
                                
                                <div style="color: #00c851; font-size: 3em; margin-bottom: 20px;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                
                                <h2 style="color: #fff; margin-bottom: 15px; font-size: 0.8em;">DEPLOYMENT SUCCESSFUL!</h2>
                                
                                <p style="color: #e5e5e5; margin-bottom: 25px; font-size: 0.6em; line-height: 1.5;">
                                    YOUR WORKFLOW "${data?.workflow_name || 'WORKFLOW'}" HAS BEEN<br/>
                                    SUCCESSFULLY DEPLOYED TO YOUR N8N WORKSPACE.
                                </p>
                                
                                ${data ? `
                                <div style="background: rgba(0, 200, 81, 0.1); border: 1px solid #00c851; 
                                           border-radius: 10px; padding: 15px; margin-bottom: 25px;">
                                    <p style="color: #00c851; margin: 0; font-size: 0.5em; line-height: 1.5;">
                                        <strong>WORKFLOW ID:</strong> ${data.n8n_workflow_id}<br/>
                                        <strong>INSTANCE:</strong> ${data.n8n_instance_url}
                                    </p>
                                </div>
                                ` : ''}
                                
                                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                    ${data?.workflow_url ? `
                                    <a href="${data.workflow_url}" target="_blank" style="
                                        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                                        color: white; text-decoration: none; padding: 12px 20px; 
                                        border-radius: 8px; font-weight: bold; transition: all 0.3s;
                                        font-family: 'Press Start 2P', monospace; font-size: 0.5em;">
                                        OPEN IN N8N
                                    </a>
                                    ` : ''}
                                    <button onclick="closeUnifiedModal()" style="
                                        background: #6c757d; color: white; border: none; padding: 12px 20px; 
                                        border-radius: 8px; cursor: pointer; font-family: 'Press Start 2P', monospace;
                                        font-size: 0.5em;">
                                        CLOSE
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
        }
        
        function closeUnifiedModal() {
            const modals = document.querySelectorAll('.unified-deployment-modal, .deployment-success-modal, .deployment-notification');
            modals.forEach(modal => modal.remove());
        }


        
        function showDeploymentSuccess(deploymentData) {
            showUnifiedDeploymentModal('success', deploymentData);
        }
        

        
        function openUserProfile() {
            // Navigate to user profile page
            window.location.href = '/profile';
        }



        // Function to load user-uploaded workflows
        function loadUserUploadedWorkflows() {
            // Authentication check removed for local development

            const container = document.getElementById('userWorkflowsContainer');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8a8aa0;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2em; margin-bottom: 15px;"></i>
                        <p>Loading your workflows...</p>
                    </div>
                `;
            }

            fetchWithAuth('/api/user/uploaded-workflows')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayUserUploadedWorkflows(data.workflows);
                } else {
                    console.error('Failed to load user-uploaded workflows:', data.error);
                    if (container) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #dc3545;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 15px;"></i>
                                <p>Failed to load workflows: ${data.error}</p>
                                <button onclick="loadUserUploadedWorkflows()" class="category-btn" style="margin-top: 15px;">
                                    <i class="fas fa-retry me-2"></i>Try Again
                                </button>
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading user-uploaded workflows:', error);
                showNotification('Error loading workflows', 'error');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 15px;"></i>
                            <p>Network error loading workflows</p>
                            <button onclick="loadUserUploadedWorkflows()" class="category-btn" style="margin-top: 15px;">
                                <i class="fas fa-retry me-2"></i>Try Again
                            </button>
                        </div>
                    `;
                }
            });
        }

        // Function to load MCP servers
        function loadMCPServers() {
            // Authentication check removed for local development

            const container = document.getElementById('mcpServersContainer');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8a8aa0;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2em; margin-bottom: 15px;"></i>
                        <p>Loading your MCP servers...</p>
                    </div>
                `;
            }

            fetchWithAuth('/api/user/mcp-servers')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayMCPServers(data.mcp_servers);
                } else {
                    console.error('Failed to load MCP servers:', data.error);
                    if (container) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #dc3545;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 15px;"></i>
                                <p>Failed to load MCP servers: ${data.error}</p>
                                <button onclick="loadMCPServers()" class="category-btn" style="margin-top: 15px;">
                                    <i class="fas fa-retry me-2"></i>Try Again
                                </button>
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading MCP servers:', error);
                showNotification('Error loading MCP servers', 'error');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2em; margin-bottom: 15px;"></i>
                            <p>Network error loading MCP servers</p>
                            <button onclick="loadMCPServers()" class="category-btn" style="margin-top: 15px;">
                                <i class="fas fa-retry me-2"></i>Try Again
                            </button>
                        </div>
                    `;
                }
            });
        }

        // Function to display MCP servers
        function displayMCPServers(mcpServers) {
            const container = document.getElementById('mcpServersContainer');
            if (!container) return;

            if (mcpServers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #8a8aa0;">
                        <i class="fas fa-server" style="font-size: 4em; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h3 style="color: #e5e5e5; margin-bottom: 10px;">No MCP Servers</h3>
                        <p>You haven't deployed any workflows as MCP servers yet.</p>
                        <p style="margin-bottom: 25px;">Deploy a workflow above to create your first MCP server!</p>
                    </div>
                `;
                return;
            }

            const serversHTML = mcpServers.map(server => {
                const statusIndicator = server.mcp_build_success ? 'status-indicator' : 'status-indicator failed';
                const statusText = server.mcp_build_success ? 'Active' : 'Build Failed';
                const statusColor = server.mcp_build_success ? '#28a745' : '#dc3545';
                const createdDate = server.mcp_created_at ? new Date(server.mcp_created_at).toLocaleDateString() : 'N/A';
                
                return `
                    <div class="mcp-server-card">
                        <div class="mcp-server-header">
                            <div class="mcp-server-icon">üîó</div>
                            <div class="mcp-server-info">
                                <h4>${server.workflow_name || 'MCP Server'}</h4>
                                <p>Workflow ID: ${server.n8n_workflow_id}</p>
                            </div>
                        </div>
                        
                        <div class="mcp-server-url">
                            <div class="mcp-server-url-text" id="mcpUrl-${server.n8n_workflow_id}">
                                ${server.mcp_server_path}
                            </div>
                            <button class="copy-btn" onclick="copyMCPUrl(event, '${server.n8n_workflow_id}', '${server.mcp_server_path}', '${server.workflow_name}')">
                                <i class="fas fa-copy"></i>
                                Copy
                            </button>
                        </div>
                        
                        <div class="mcp-server-meta">
                            <div class="mcp-server-status">
                                <div class="${statusIndicator}"></div>
                                <span style="color: ${statusColor};">${statusText}</span>
                            </div>
                            <div class="mcp-server-date">
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = serversHTML;
        }

        // Function to copy MCP URL to clipboard
        function copyMCPUrl(event, workflowId, mcpUrl, workflowName) {
            // Only copy the MCP URL path
            navigator.clipboard.writeText(mcpUrl).then(() => {
                // Update button to show success
                const copyBtn = event.currentTarget || event.target;
                
                if (copyBtn) {
                    const originalHTML = copyBtn.innerHTML;
                    
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    copyBtn.classList.add('copied');
                    
                    // Reset after 2 seconds
                    setTimeout(() => {
                        if (copyBtn) {
                            copyBtn.innerHTML = originalHTML;
                            copyBtn.classList.remove('copied');
                        }
                    }, 2000);
                }
                
                showNotification('MCP server URL copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showNotification('Failed to copy URL: ' + err.message, 'error');
            });
        }


        // Function to display user-uploaded workflows
        function displayUserUploadedWorkflows(workflows) {
            const container = document.getElementById('userWorkflowsContainer');
            if (!container) return;
            
            // Debug: Log the first workflow to see what fields are available
            if (workflows.length > 0) {
                console.log('Debug - First workflow data:', workflows[0]);
                console.log('Debug - created_at field:', workflows[0].created_at);
                console.log('Debug - All workflow fields:', Object.keys(workflows[0]));
            }

            if (workflows.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #8a8aa0;">
                        <i class="fas fa-upload" style="font-size: 4em; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h3 style="color: #e5e5e5; margin-bottom: 10px;">No Uploaded Workflows</h3>
                        <p>You haven't uploaded any workflow files yet.</p>
                        <p style="margin-bottom: 25px;">Use the upload options above to get started!</p>
                    </div>
                `;
                return;
            }

            const workflowsHTML = workflows.map(workflow => `
                <div class="workflow-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #e5e5e5;">${workflow.workflow_name}</h4>
                        <span class="badge" style="background: #28a745; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.7em;">
                            User Upload
                        </span>
                    </div>
                    <p style="color: #8a8aa0; margin-bottom: 15px;">${workflow.workflow_description || 'No description provided'}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <small style="color: #666;">
                            <i class="fas fa-calendar me-1"></i>
                            ${workflow.created_at ? new Date(workflow.created_at).toLocaleDateString() : 'Date unavailable'}
                        </small>
                        <small style="color: #666;">
                            <i class="fas fa-database me-1"></i>
                            ID: ${workflow.template_id?.slice(-8) || 'N/A'}
                        </small>
                    </div>
                    <div class="workflow-actions" style="display: flex; gap: 10px;">
                        <button onclick="loadWorkflowForEditing('${workflow.template_id}')" style="
                            flex: 1; padding: 8px 12px; background: #667eea; border: none; 
                            color: white; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                            <i class="fas fa-edit me-1"></i>Configure
                        </button>
                        <button onclick="deleteUserWorkflow('${workflow.template_id}')" style="
                            padding: 8px 12px; background: #dc3545; border: none; 
                            color: white; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = workflowsHTML;
        }

        // Function to load workflow for editing
        function loadWorkflowForEditing(templateId) {
            if (!isUserAuthenticated()) {
                return;
            }

            showNotification('Loading workflow...', 'info');
            
            fetchWithAuth(`/api/user/uploaded-workflows`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const workflow = data.workflows.find(w => w.template_id === templateId);
                    
                    if (workflow) {
                        // Parse workflow_json if it's a string
                        let workflowJson = workflow.workflow_json;
                        
                        if (typeof workflowJson === 'string') {
                            try {
                                workflowJson = JSON.parse(workflowJson);
                            } catch (e) {
                                console.error('Failed to parse workflow_json:', e);
                                showNotification('Error: Invalid workflow JSON format', 'error');
                                return;
                            }
                        } else if (typeof workflowJson !== 'object' || workflowJson === null) {
                            console.error('No valid workflow JSON found in database');
                            showNotification('Error: No valid workflow JSON found in database', 'error');
                            return;
                        }

                        // Set up the workflow data for editing
                        currentWorkflowData = {
                            workflow_json: workflowJson,
                            // CRITICAL: Store the original workflow JSON for deployment
                            original_workflow_json: workflowJson,
                            workflow_info: {
                                name: workflow.workflow_name,
                                description: workflow.workflow_description
                            },
                            workflow_name: workflow.workflow_name, // Also store at top level
                            template_id: workflow.template_id,
                            is_user_upload: true,
                            credentials_required: workflow.credentials_required || []
                        };
                        
                        // Store workflow for editing/deployment
                        
                        // Prepare workflow data for shared interface
                        const workflowData = {
                            workflow_name: workflow.workflow_name,
                            workflow_description: workflow.workflow_description || 'No description available',
                            workflow_json: workflowJson,
                            credentials_required: workflow.credentials_required || []
                        };
                        
                        // Parse the workflow to get credential requirements if needed
                        
                        fetchWithAuth('/api/parse-workflow-json', {
                            method: 'POST',
                            body: JSON.stringify({
                                workflow_json: workflowJson,
                                manual_workflow_name: workflow.workflow_name
                            })
                        })
                        .then(response => response.json())
                        .then(parsedData => {
                            console.log('üîß EDITING: Parsed workflow data received:', parsedData);
                            console.log('üîß EDITING: Parsed data keys:', Object.keys(parsedData));
                            console.log('üîß EDITING: Parsed data template_id:', parsedData.template_id);
                            
                            // CRITICAL: Ensure the original workflow JSON is preserved in parsedData
                            if (!parsedData.original_workflow_json && workflowJson) {
                                console.log('üîß EDITING: Adding original_workflow_json to parsedData');
                                parsedData.original_workflow_json = workflowJson;
                            }
                            
                            if (!parsedData.template_id && workflow.template_id) {
                                console.log('üîß EDITING: Adding template_id to parsedData');
                                parsedData.template_id = workflow.template_id;
                            }
                            
                            console.log('üîß EDITING: Final parsedData with preserved fields:', {
                                hasOriginalWorkflowJson: !!parsedData.original_workflow_json,
                                hasTemplateId: !!parsedData.template_id,
                                hasWorkflowJson: !!parsedData.workflow_json,
                                keys: Object.keys(parsedData)
                            });
                            
                            // Show unified workflow configuration interface (same as upload)
                            showWorkflowConfiguration(parsedData);
                        })
                        .catch(error => {
                            console.error('Error parsing workflow for editing:', error);
                            // Show interface without parsed data if parsing fails
                            showWorkflowConfiguration({
                                workflow_name: workflowData.workflow_name,
                                workflow_description: workflowData.workflow_description,
                                workflow_json: workflowData.workflow_json
                            });
                        });
                        showNotification('Workflow loaded successfully!', 'success');
                    } else {
                        showNotification('Workflow not found', 'error');
                    }
                } else {
                    showNotification('Failed to load workflow', 'error');
                }
            })
            .catch(error => {
                console.error('Error loading workflow:', error);
                showNotification('Error loading workflow', 'error');
            });
        }

        // Function to delete user workflow
        function deleteUserWorkflow(templateId) {
            if (!confirm('Are you sure you want to delete this workflow? This action cannot be undone.')) {
                return;
            }

            if (!isUserAuthenticated()) {
                return;
            }

            showNotification('Deleting workflow...', 'info');
            
            fetchWithAuth(`/api/user/uploaded-workflows/${templateId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Workflow deleted successfully!', 'success');
                    loadUserUploadedWorkflows(); // Refresh the list
                } else {
                    showNotification(data.error || 'Failed to delete workflow', 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting workflow:', error);
                showNotification('Error deleting workflow', 'error');
            });
        }



        // Function to process workflow credentials from stored database data
        function processWorkflowCredentialsFromStored(credentialsRequired, workflowJson) {
            // Processing workflow credentials from stored data
            
            if (!credentialsRequired || credentialsRequired.length === 0) {
                // No credentials required according to stored data
                
                const credentialsSection = document.getElementById('workflowCredentialsSection');
                if (credentialsSection) {
                    credentialsSection.style.display = 'block';
                    credentialsSection.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #8a8aa0;">
                            <i class="fas fa-check-circle" style="font-size: 3em; margin-bottom: 20px; color: #28a745;"></i>
                            <h3 style="color: #e5e5e5;">No Credentials Required</h3>
                            <p>This workflow doesn't require any external service credentials.</p>
                            <p>You can deploy it directly to your N8N instance!</p>
                        </div>
                    `;
                }
                return;
            }

            // Show loading state
            const credentialsSection = document.getElementById('workflowCredentialsSection');
            if (credentialsSection) {
                credentialsSection.style.display = 'block';
                credentialsSection.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8a8aa0;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <p>Loading credentials from stored data...</p>
                    </div>
                `;
            }

            // Create form config from stored credentials data with correct structure for WorkflowCredentialForm
            const formConfig = {
                workflow_name: currentWorkflowData?.workflow_info?.name || 'User Workflow',
                workflow_description: currentWorkflowData?.workflow_info?.description || 'User uploaded workflow',
                form_sections: [
                    {
                        category: 'credentials',
                        category_display: 'Required Services',
                        services: credentialsRequired.map(serviceName => ({
                            service_name: serviceName,
                            service_display_name: serviceName.charAt(0).toUpperCase() + serviceName.slice(1).replace(/([A-Z])/g, ' $1'),
                            icon: 'üîë',
                            credential_type: 'api_key',
                            description: `Configure ${serviceName} credentials for this workflow`,
                            fields: [
                                {
                                    name: 'api_key',
                                    type: 'password',
                                    display_name: 'API Key',
                                    placeholder: `Enter your ${serviceName} API key`,
                                    required: true
                                }
                            ]
                        }))
                    }
                ]
            };

            // Safely parse workflowJson if it's a string
            let parsedWorkflowJson = workflowJson;
            if (typeof workflowJson === 'string') {
                try {
                    parsedWorkflowJson = JSON.parse(workflowJson);
                } catch (e) {
                    console.error('Failed to parse workflowJson parameter:', e);
                    parsedWorkflowJson = {};
                }
            } else if (!workflowJson || typeof workflowJson !== 'object') {
                parsedWorkflowJson = {};
            }

            // Add total_nodes to formConfig for the new UI
            formConfig.total_nodes = (parsedWorkflowJson?.nodes || []).length || 0;
            
            // Create mock parsed data structure
            const parsedData = {
                success: true,
                form_config: formConfig,
                workflow_info: {
                    name: currentWorkflowData?.workflow_info?.name || 'User Workflow',
                    description: currentWorkflowData?.workflow_info?.description || 'User uploaded workflow',
                    total_nodes: formConfig.total_nodes
                }
            };
            
            // Display the credentials form
            setTimeout(() => {
                displayWorkflowCredentialsForm(parsedData);
            }, 500);
        }

        // Function to process workflow credentials
        function processWorkflowCredentials(workflowJson) {
            if (!workflowJson) {
                console.error('No workflow JSON provided to processWorkflowCredentials');
                showNotification('No workflow data found', 'error');
                return;
            }

            // Show loading state in credentials section
            const credentialsSection = document.getElementById('workflowCredentialsSection');
            if (credentialsSection) {
                credentialsSection.style.display = 'block';
                credentialsSection.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8a8aa0;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <p>Analyzing workflow for credential requirements...</p>
                    </div>
                `;
            }

            // Call the API to parse the workflow and get credential requirements
            fetch('/api/parse-workflow-json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    workflow_json: workflowJson,
                    manual_workflow_name: currentWorkflowData?.workflow_info?.name || 'Loaded Workflow'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.form_config && data.form_config.form_sections && data.form_config.form_sections.length > 0) {
                        // Display the credential form
                        displayWorkflowCredentialsForm(data);
                    } else {
                        // No credentials required
                        if (credentialsSection) {
                            credentialsSection.innerHTML = `
                                <div style="text-align: center; padding: 40px; color: #8a8aa0;">
                                    <i class="fas fa-check-circle" style="font-size: 3em; margin-bottom: 20px; color: #28a745;"></i>
                                    <h3 style="color: #e5e5e5;">No Credentials Required</h3>
                                    <p>This workflow doesn't require any external service credentials.</p>
                                    <p>You can deploy it directly to your N8N instance!</p>
                                </div>
                            `;
                        }
                    }
                } else {
                    console.error('Failed to parse workflow:', data.error);
                    if (credentialsSection) {
                        credentialsSection.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #dc3545;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                                <h3>Error Analyzing Workflow</h3>
                                <p>${data.error || 'Failed to analyze workflow for credentials'}</p>
                                <button onclick="processWorkflowCredentials(currentWorkflowData.workflow_json)" class="category-btn" style="margin-top: 20px;">
                                    <i class="fas fa-retry me-2"></i>Try Again
                                </button>
                            </div>
                        `;
                    }
                    showNotification('Failed to analyze workflow credentials', 'error');
                }
            })
            .catch(error => {
                console.error('Error processing workflow credentials:', error);
                if (credentialsSection) {
                    credentialsSection.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                            <h3>Connection Error</h3>
                            <p>Unable to analyze workflow. Please check your connection and try again.</p>
                            <button onclick="processWorkflowCredentials(currentWorkflowData.workflow_json)" class="category-btn" style="margin-top: 20px;">
                                <i class="fas fa-retry me-2"></i>Try Again
                            </button>
                        </div>
                    `;
                }
                showNotification('Error analyzing workflow credentials', 'error');
            });
        }

        // Function to render unified workflow card (shared for upload and load)
        function renderUnifiedWorkflowCard(workflowData) {
            const workflowCard = document.getElementById('unifiedWorkflowCard');
            if (!workflowCard) return;
            
            // Count services and nodes
            const totalServices = workflowData.credentials_required ? workflowData.credentials_required.length : 0;
            const totalNodes = workflowData.workflow_json ? (workflowData.workflow_json.nodes || []).length : 0;
            
            workflowCard.innerHTML = `
                <div style="background: #2a2a3e; border-radius: 12px; padding: 25px; border: 1px solid #444;">
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <div style="background: #667eea; width: 50px; height: 50px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                            <i class="fas fa-cog" style="color: white; font-size: 20px;"></i>
                        </div>
                        <div>
                            <h3 style="color: #e5e5e5; margin: 0; font-size: 1.4em;">${workflowData.workflow_name || 'Workflow'}</h3>
                            <p style="color: #8a8aa0; margin: 0;">${workflowData.workflow_description || 'No description available'}</p>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: #333344; border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="color: #667eea; font-size: 2em; margin-bottom: 5px;">
                                <i class="fas fa-puzzle-piece"></i>
                            </div>
                            <div style="color: #e5e5e5; font-size: 1.2em; font-weight: bold;">${totalNodes}</div>
                            <div style="color: #8a8aa0; font-size: 0.9em;">NODES</div>
                        </div>
                        <div style="background: #333344; border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="color: #667eea; font-size: 2em; margin-bottom: 5px;">
                                <i class="fas fa-key"></i>
                            </div>
                            <div style="color: #e5e5e5; font-size: 1.2em; font-weight: bold;">${totalServices}</div>
                            <div style="color: #8a8aa0; font-size: 0.9em;">SERVICES</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px;">
                        <button type="button" id="configureCredentialsBtn" onclick="toggleCredentialPanel()" style="
                            flex: 1; background: #667eea; color: white; border: none; padding: 12px 20px; 
                            border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95em;
                            transition: background-color 0.2s;">
                            <i class="fas fa-cog me-2"></i>CONFIGURE CREDENTIALS
                        </button>
                        <button type="button" id="saveWorkflowBtn" onclick="startWorkflowConfiguration()" style="
                            background: #28a745; color: white; border: none; padding: 12px 20px; 
                            border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95em;
                            font-family: 'Press Start 2P', monospace; font-size: 0.6em;">
                            <i class="fas fa-cog me-2"></i>CONFIGURE & SAVE
                        </button>
                    </div>
                </div>
            `;
        }
        

        
        // Function to prepare credential form
        function prepareCredentialForm(parsedData) {
            const credentialsSection = document.getElementById('workflowCredentialsSection');
            if (!credentialsSection) return;

            // Prepare credential form
            
            // Create the credentials form container with forced styling
            credentialsSection.innerHTML = `
                <div class="credentials-form-container" style="background: transparent; color: #e5e5e5; font-family: 'Press Start 2P', monospace;">
                    <div id="workflowCredentialsForm"></div>
                </div>
            `;

            // Initialize the credential form
            try {
                let formConfig = parsedData?.form_config;
                
                console.log('üîß CREDENTIAL FORM: Form config:', formConfig);
                
                // If no form_config or it's empty, try to create one from stored workflow data
                if (!formConfig || !formConfig.form_sections || formConfig.form_sections.length === 0) {
                    console.log('üîß CREDENTIAL FORM: No form_config found, creating from stored workflow data');
                    formConfig = createFormConfigFromWorkflowData();
                }
                
                console.log('üîß CREDENTIAL FORM: Final form config for initialization:', formConfig);
                
                if (formConfig && formConfig.form_sections && formConfig.form_sections.length > 0) {
                    window.workflowCredentialForm = new WorkflowCredentialForm('workflowCredentialsForm', formConfig);
                    console.log('‚úÖ CREDENTIAL FORM: Successfully initialized');
                    
                    // Force dark theme styling after form is rendered
                    setTimeout(() => {
                        applyDarkThemeToCredentialForm();
                        customizeFormNavigation();
                    }, 100);
                } else {
                    console.log('‚ö†Ô∏è CREDENTIAL FORM: No credentials required, showing message');
                    credentialsSection.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #8a8aa0; font-family: 'Press Start 2P', monospace;">
                            <i class="fas fa-check-circle" style="font-size: 3em; margin-bottom: 20px; opacity: 0.5;"></i>
                            <h3 style="color: #e5e5e5; margin-bottom: 15px; font-weight: 600;">No credential requirements found</h3>
                            <p style="color: #8a8aa0;">This workflow doesn't require any external service credentials.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå CREDENTIAL FORM: Error initializing:', error);
                credentialsSection.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545; font-family: 'Press Start 2P', monospace;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3em; margin-bottom: 20px;"></i>
                        <h3 style="color: #e5e5e5; margin-bottom: 15px; font-weight: 600;">Form Initialization Error</h3>
                        <p style="color: #8a8aa0; margin-bottom: 10px;">Failed to initialize the credentials form. Please refresh and try again.</p>
                        <p style="font-size: 0.9em; margin-top: 10px; color: #666; font-family: monospace; background: #1a1a2e; padding: 8px; border-radius: 4px; word-break: break-all;">Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Function to create form config from workflow data when API parsing fails
        function createFormConfigFromWorkflowData() {
            const workflowData = window.currentSharedWorkflowData;
            if (!workflowData || !workflowData.credentials_required || workflowData.credentials_required.length === 0) {
                console.log('üîß FALLBACK: No workflow data or credentials_required');
                return null;
            }
            
            console.log('üîß FALLBACK: Creating form config from credentials:', workflowData.credentials_required);
            
            // Convert stored credentials array to form_config structure
            const services = workflowData.credentials_required.map(serviceName => ({
                service_name: serviceName,
                display_name: serviceName,
                service_display_name: serviceName,
                icon: 'üîë',
                credential_type: 'api_key',
                description: `Configure your ${serviceName} API credentials`,
                documentation_url: null,
                fields: [
                    {
                        name: 'api_key',
                        display_name: 'API Key',
                        type: 'password',
                        required: true,
                        placeholder: `Enter your ${serviceName} API key`,
                        help_text: `API key for ${serviceName} service`
                    }
                ],
                connection_info: {
                    required: true,
                    test_endpoint: null
                }
            }));
            
            const formConfig = {
                workflow_name: workflowData.workflow_name,
                total_services: services.length,
                form_sections: [
                    {
                        section_name: 'Required Services',
                        services: services
                    }
                ]
            };
            
            console.log('üîß FALLBACK: Generated form config:', formConfig);
            return formConfig;
        }
        
        // Function to apply dark theme styling to credential form
        function applyDarkThemeToCredentialForm() {
            console.log('üé® Applying dark theme to credential form...');
            
            const formContainer = document.getElementById('workflowCredentialsForm');
            if (!formContainer) return;
            
            // Apply base styles to container with proper font
            formContainer.style.cssText = `
                background: transparent !important;
                color: #e5e5e5 !important;
                font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif !important;
                font-size: 14px !important;
                line-height: 1.5 !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            `;
            
            // Style service cards to match workflow card design
            const serviceCards = formContainer.querySelectorAll('.service-card, .card');
            serviceCards.forEach(card => {
                card.style.cssText = `
                    background: #2a2a3e !important;
                    border: 1px solid #444 !important;
                    border-radius: 12px !important;
                    margin-bottom: 15px !important;
                    overflow: hidden !important;
                    box-shadow: none !important;
                    font-family: inherit !important;
                `;
            });
            
            // Style card headers to be cleaner
            const cardHeaders = formContainer.querySelectorAll('.card-header');
            cardHeaders.forEach(header => {
                header.style.cssText = `
                    background: #333344 !important;
                    border-bottom: 1px solid #444 !important;
                    color: #e5e5e5 !important;
                    padding: 20px !important;
                    font-family: inherit !important;
                `;
            });
            
            // Style service headers specifically
            const serviceHeaders = formContainer.querySelectorAll('.service-header');
            serviceHeaders.forEach(header => {
                header.style.cssText = `
                    display: flex !important;
                    align-items: center !important;
                    gap: 15px !important;
                    font-family: inherit !important;
                `;
            });
            
            // Style service icons
            const serviceIcons = formContainer.querySelectorAll('.service-icon');
            serviceIcons.forEach(icon => {
                icon.style.cssText = `
                    background: #667eea !important;
                    color: white !important;
                    width: 40px !important;
                    height: 40px !important;
                    border-radius: 8px !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    font-size: 16px !important;
                    flex-shrink: 0 !important;
                `;
            });
            
            // Style service info
            const serviceInfos = formContainer.querySelectorAll('.service-info');
            serviceInfos.forEach(info => {
                info.style.cssText = `
                    flex: 1 !important;
                    min-width: 0 !important;
                `;
            });
            
            // Style card bodies with better spacing
            const cardBodies = formContainer.querySelectorAll('.card-body');
            cardBodies.forEach(body => {
                body.style.cssText = `
                    background: #2a2a3e !important;
                    color: #e5e5e5 !important;
                    padding: 0 !important;
                    font-family: inherit !important;
                `;
            });
            
            // Style service fields container
            const serviceFields = formContainer.querySelectorAll('.service-fields');
            serviceFields.forEach(fields => {
                fields.style.cssText = `
                    padding: 20px !important;
                    background: #2a2a3e !important;
                `;
            });
            
            // Style form groups
            const formGroups = formContainer.querySelectorAll('.form-group');
            formGroups.forEach(group => {
                group.style.cssText = `
                    margin-bottom: 20px !important;
                    font-family: inherit !important;
                `;
            });
            
            // Style form labels with proper typography
            const labels = formContainer.querySelectorAll('.form-label, label');
            labels.forEach(label => {
                label.style.cssText = `
                    color: #e5e5e5 !important;
                    font-weight: 600 !important;
                    font-size: 14px !important;
                    margin-bottom: 8px !important;
                    display: block !important;
                    font-family: inherit !important;
                    line-height: 1.4 !important;
                `;
            });
            
            // Style form controls with consistent sizing
            const formControls = formContainer.querySelectorAll('.form-control, input, textarea, select');
            formControls.forEach(control => {
                control.style.cssText = `
                    background: #1a1a2e !important;
                    border: 1px solid #444 !important;
                    color: #e5e5e5 !important;
                    border-radius: 8px !important;
                    padding: 12px 15px !important;
                    font-size: 14px !important;
                    font-family: inherit !important;
                    line-height: 1.5 !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                    transition: border-color 0.2s ease !important;
                `;
                
                // Add focus styles
                control.addEventListener('focus', function() {
                    this.style.borderColor = '#667eea !important';
                    this.style.outline = 'none !important';
                });
                
                control.addEventListener('blur', function() {
                    this.style.borderColor = '#444 !important';
                });
            });
            
            // Style placeholder text
            const inputs = formContainer.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.style.setProperty('--placeholder-color', '#8a8aa0', 'important');
            });
            
            // Style buttons with consistent design
            const buttons = formContainer.querySelectorAll('.btn');
            buttons.forEach(button => {
                const baseButtonStyle = `
                    font-family: inherit !important;
                    font-size: 13px !important;
                    font-weight: 500 !important;
                    border-radius: 6px !important;
                    padding: 8px 16px !important;
                    transition: all 0.2s ease !important;
                    border-width: 1px !important;
                    text-decoration: none !important;
                    cursor: pointer !important;
                    display: inline-flex !important;
                    align-items: center !important;
                    gap: 6px !important;
                `;
                
                if (button.classList.contains('btn-outline-primary')) {
                    button.style.cssText = baseButtonStyle + `
                        background: transparent !important;
                        border-color: #667eea !important;
                        color: #667eea !important;
                    `;
                    
                    button.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#667eea !important';
                        this.style.color = 'white !important';
                    });
                    
                    button.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'transparent !important';
                        this.style.color = '#667eea !important';
                    });
                } else if (button.classList.contains('btn-outline-secondary')) {
                    button.style.cssText = baseButtonStyle + `
                        background: transparent !important;
                        border-color: #666 !important;
                        color: #8a8aa0 !important;
                    `;
                    
                    button.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#444 !important';
                        this.style.color = '#e5e5e5 !important';
                    });
                    
                    button.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'transparent !important';
                        this.style.color = '#8a8aa0 !important';
                    });
                }
            });
            
            // Style help text and small text
            const helpTexts = formContainer.querySelectorAll('.form-text, small, .text-muted');
            helpTexts.forEach(text => {
                text.style.cssText = `
                    color: #8a8aa0 !important;
                    font-size: 12px !important;
                    margin-top: 5px !important;
                    font-family: inherit !important;
                    line-height: 1.4 !important;
                `;
            });
            
            // Style service headings with proper typography
            const headings = formContainer.querySelectorAll('h5');
            headings.forEach(heading => {
                heading.style.cssText = `
                    color: #e5e5e5 !important;
                    font-weight: 600 !important;
                    font-size: 16px !important;
                    margin: 0 0 4px 0 !important;
                    font-family: inherit !important;
                    line-height: 1.4 !important;
                `;
            });
            
            // Style badges
            const badges = formContainer.querySelectorAll('.badge, .badge-info');
            badges.forEach(badge => {
                badge.style.cssText = `
                    background: #667eea !important;
                    color: white !important;
                    padding: 4px 8px !important;
                    border-radius: 12px !important;
                    font-size: 11px !important;
                    font-weight: 500 !important;
                    text-transform: uppercase !important;
                    letter-spacing: 0.5px !important;
                    font-family: inherit !important;
                `;
            });
            
            // Style service actions with clean design
            const serviceActions = formContainer.querySelectorAll('.service-actions');
            serviceActions.forEach(actions => {
                actions.style.cssText = `
                    background: #333344 !important;
                    border-top: 1px solid #444 !important;
                    padding: 15px 20px !important;
                    margin: 0 !important;
                    display: flex !important;
                    gap: 10px !important;
                    align-items: center !important;
                `;
            });
            
            // Style navigation area
            const navigation = formContainer.querySelectorAll('.form-navigation');
            navigation.forEach(nav => {
                nav.style.cssText = `
                    display: flex !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                    padding: 20px 0 !important;
                    border-top: 1px solid #444 !important;
                    margin-top: 20px !important;
                    font-family: inherit !important;
                `;
            });
            
            // Add NFT/Gaming vibe CSS for the form
            const style = document.createElement('style');
            style.textContent = `
                /* NFT Gaming Font - matching workflow configuration */
                #workflowCredentialsForm,
                #workflowCredentialsForm * {
                    font-family: 'Press Start 2P', monospace !important;
                    font-weight: 600 !important;
                    text-transform: uppercase !important;
                    letter-spacing: 1px !important;
                }
                
                /* Gaming container with purple gradient background */
                #workflowCredentialsForm {
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%) !important;
                    border-radius: 15px !important;
                    padding: 20px !important;
                    position: relative !important;
                    overflow: hidden !important;
                }
                
                #workflowCredentialsForm::before {
                    content: '' !important;
                    position: absolute !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    background: linear-gradient(45deg, rgba(138, 43, 226, 0.1) 0%, rgba(75, 0, 130, 0.1) 100%) !important;
                    pointer-events: none !important;
                    z-index: 0 !important;
                }
                
                #workflowCredentialsForm > * {
                    position: relative !important;
                    z-index: 1 !important;
                }
                
                /* Placeholder styling with gaming vibe */
                #workflowCredentialsForm input::placeholder,
                #workflowCredentialsForm textarea::placeholder {
                    color: #8a8aa0 !important;
                    opacity: 0.7 !important;
                    font-style: italic !important;
                    text-transform: none !important;
                    letter-spacing: 0.5px !important;
                }
                
                #workflowCredentialsForm input::-webkit-input-placeholder,
                #workflowCredentialsForm textarea::-webkit-input-placeholder {
                    color: #8a8aa0 !important;
                    font-style: italic !important;
                    text-transform: none !important;
                }
                
                #workflowCredentialsForm input::-moz-placeholder,
                #workflowCredentialsForm textarea::-moz-placeholder {
                    color: #8a8aa0 !important;
                    opacity: 0.7 !important;
                    font-style: italic !important;
                    text-transform: none !important;
                }
                
                /* Gaming card design */
                #workflowCredentialsForm .card {
                    background: linear-gradient(135deg, #1e1e30 0%, #2a2a3e 100%) !important;
                    border: 2px solid #4a4a6a !important;
                    border-radius: 15px !important;
                    margin-bottom: 20px !important;
                    color: #ffffff !important;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
                    position: relative !important;
                    overflow: hidden !important;
                }
                
                #workflowCredentialsForm .card::before {
                    content: '' !important;
                    position: absolute !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    height: 3px !important;
                    background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57) !important;
                }
                
                #workflowCredentialsForm .card-header {
                    background: linear-gradient(135deg, #2d1b69 0%, #1a1a2e 100%) !important;
                    border-bottom: 2px solid #4a4a6a !important;
                    color: #ffffff !important;
                    padding: 25px !important;
                    position: relative !important;
                }
                
                #workflowCredentialsForm .card-body {
                    background: transparent !important;
                    color: #ffffff !important;
                    padding: 25px !important;
                }
                
                /* Gaming form controls */
                #workflowCredentialsForm .form-control {
                    background: rgba(26, 26, 46, 0.8) !important;
                    border: 2px solid #4a4a6a !important;
                    color: #ffffff !important;
                    border-radius: 10px !important;
                    padding: 15px 20px !important;
                    font-size: 14px !important;
                    transition: all 0.3s ease !important;
                    text-transform: none !important;
                    letter-spacing: 0.5px !important;
                }
                
                #workflowCredentialsForm .form-control:focus {
                    background: rgba(26, 26, 46, 1) !important;
                    border-color: #ff6b6b !important;
                    color: #ffffff !important;
                    box-shadow: 0 0 20px rgba(255, 107, 107, 0.3) !important;
                    transform: translateY(-2px) !important;
                }
                
                #workflowCredentialsForm .form-label {
                    color: #ffffff !important;
                    font-weight: 700 !important;
                    margin-bottom: 10px !important;
                    font-size: 12px !important;
                    text-shadow: 0 0 10px rgba(255, 255, 255, 0.5) !important;
                }
                
                #workflowCredentialsForm .form-text {
                    color: #b8b8d4 !important;
                    font-size: 11px !important;
                    text-transform: none !important;
                    letter-spacing: 0.5px !important;
                    font-style: italic !important;
                }
                
                #workflowCredentialsForm .text-muted {
                    color: #b8b8d4 !important;
                    text-transform: none !important;
                    letter-spacing: 0.5px !important;
                }
                
                /* Gaming buttons */
                #workflowCredentialsForm .btn {
                    font-family: inherit !important;
                    font-size: 11px !important;
                    font-weight: 700 !important;
                    border-radius: 8px !important;
                    padding: 12px 20px !important;
                    transition: all 0.3s ease !important;
                    position: relative !important;
                    overflow: hidden !important;
                    text-transform: uppercase !important;
                    letter-spacing: 1px !important;
                }
                
                #workflowCredentialsForm .btn::before {
                    content: '' !important;
                    position: absolute !important;
                    top: 0 !important;
                    left: -100% !important;
                    width: 100% !important;
                    height: 100% !important;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent) !important;
                    transition: left 0.5s !important;
                }
                
                #workflowCredentialsForm .btn:hover::before {
                    left: 100% !important;
                }
                
                #workflowCredentialsForm .btn-outline-primary {
                    border: 2px solid #4ecdc4 !important;
                    color: #4ecdc4 !important;
                    background: transparent !important;
                    text-shadow: 0 0 10px rgba(78, 205, 196, 0.5) !important;
                }
                
                #workflowCredentialsForm .btn-outline-primary:hover {
                    background: #4ecdc4 !important;
                    color: #1a1a2e !important;
                    box-shadow: 0 0 20px rgba(78, 205, 196, 0.6) !important;
                    transform: translateY(-2px) !important;
                    text-shadow: none !important;
                }
                
                #workflowCredentialsForm .btn-outline-secondary {
                    border: 2px solid #6c757d !important;
                    color: #6c757d !important;
                    background: transparent !important;
                }
                
                #workflowCredentialsForm .btn-outline-secondary:hover {
                    background: #6c757d !important;
                    color: #ffffff !important;
                    box-shadow: 0 0 15px rgba(108, 117, 125, 0.4) !important;
                    transform: translateY(-2px) !important;
                }
                
                /* Gaming badges */
                #workflowCredentialsForm .badge {
                    background: linear-gradient(45deg, #ff6b6b, #4ecdc4) !important;
                    color: #ffffff !important;
                    padding: 6px 12px !important;
                    border-radius: 15px !important;
                    font-size: 10px !important;
                    font-weight: 700 !important;
                    text-shadow: 0 0 10px rgba(0, 0, 0, 0.5) !important;
                    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3) !important;
                }
                
                /* Gaming headings */
                #workflowCredentialsForm h5 {
                    color: #ffffff !important;
                    font-weight: 700 !important;
                    font-size: 16px !important;
                    margin: 0 0 8px 0 !important;
                    text-shadow: 0 0 10px rgba(255, 255, 255, 0.3) !important;
                }
                
                /* Gaming service icon */
                #workflowCredentialsForm .service-icon {
                    background: linear-gradient(45deg, #667eea, #764ba2) !important;
                    color: #ffffff !important;
                    width: 50px !important;
                    height: 50px !important;
                    border-radius: 12px !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    font-size: 20px !important;
                    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4) !important;
                    position: relative !important;
                    overflow: hidden !important;
                }
                
                #workflowCredentialsForm .service-icon::before {
                    content: '' !important;
                    position: absolute !important;
                    top: -50% !important;
                    left: -50% !important;
                    width: 200% !important;
                    height: 200% !important;
                    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent) !important;
                    animation: shimmer 2s linear infinite !important;
                }
                
                @keyframes shimmer {
                    0% { transform: translateX(-100%) translateY(-100%) rotate(30deg); }
                    100% { transform: translateX(100%) translateY(100%) rotate(30deg); }
                }
                
                /* Gaming service actions */
                #workflowCredentialsForm .service-actions {
                    background: linear-gradient(135deg, #2d1b69 0%, #1a1a2e 100%) !important;
                    border-top: 2px solid #4a4a6a !important;
                    padding: 20px 25px !important;
                    margin: 25px -25px -25px -25px !important;
                    display: flex !important;
                    gap: 15px !important;
                    align-items: center !important;
                    position: relative !important;
                }
                
                #workflowCredentialsForm .service-actions::before {
                    content: '' !important;
                    position: absolute !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    height: 1px !important;
                    background: linear-gradient(90deg, transparent, #4ecdc4, transparent) !important;
                }
            `;
            document.head.appendChild(style);
            
            console.log('‚úÖ Dark theme applied to credential form with proper alignment');
        }
        
        // Function to customize form navigation for single step
        function customizeFormNavigation() {
            const navigation = document.querySelector('.form-navigation');
            if (!navigation) return;
            
            const stepInfo = navigation.querySelector('div');
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');
            
            // If it's step 1 of 1, simplify the interface
            if (stepInfo && stepInfo.textContent.includes('Step 1 of 1')) {
                navigation.style.cssText = `
                    display: flex !important;
                    justify-content: center !important;
                    align-items: center !important;
                    padding: 20px 0 !important;
                    border-top: 1px solid #444 !important;
                    margin-top: 20px !important;
                    font-family: inherit !important;
                `;
                
                // Hide previous button and step counter
                if (prevBtn) prevBtn.style.display = 'none';
                if (stepInfo) stepInfo.style.display = 'none';
                
                // Style the complete button to match your interface
                if (nextBtn) {
                    nextBtn.style.cssText = `
                        background: #28a745 !important;
                        border: none !important;
                        color: white !important;
                        padding: 12px 24px !important;
                        border-radius: 8px !important;
                        font-weight: 600 !important;
                        font-size: 14px !important;
                        font-family: inherit !important;
                        cursor: pointer !important;
                        transition: background-color 0.2s ease !important;
                    `;
                    
                    nextBtn.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#218838 !important';
                    });
                    
                    nextBtn.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = '#28a745 !important';
                    });
                }
            }
            
            console.log('‚úÖ Form navigation customized');
        }
        
        // Function to start workflow configuration process
        function startWorkflowConfiguration() {
            // Just scroll to the credential form and show a notification
            const credentialsSection = document.getElementById('workflowCredentialsSection');
            if (credentialsSection) {
                setTimeout(() => {
                    credentialsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
            }
            if (window.currentSharedWorkflowData && window.currentSharedWorkflowData.credentials_required && 
                window.currentSharedWorkflowData.credentials_required.length > 0) {
                showNotification('Configure your credentials below, then complete the setup to deploy!', 'info');
            } else {
                // No credentials required, show deploy section directly
                showDeploySection();
                showNotification('No credentials required! Ready to deploy to N8N.', 'success');
            }
        }

        // Function to save current workflow (legacy)
        function saveCurrentWorkflow() {
            // Implementation for saving workflow
            showNotification('Workflow saved successfully!', 'success');
        }
        
        // Function to hide workflow configuration
        function hideWorkflowConfiguration() {
            const configSection = document.getElementById('workflowConfiguration');
            if (configSection) {
                configSection.style.display = 'none';
            }
            
            // Clear global data
            window.currentWorkflowData = null;
        }
        
        // Legacy function for backward compatibility - now redirects to unified interface
        function displayWorkflowCredentialsForm(parsedData) {
            // Use the same configuration interface as upload
            showWorkflowConfiguration(parsedData);
        }

        // Function to switch between workflow tabs
        function switchWorkflowTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            const tabElement = document.getElementById(tabName + 'Tab');
            const contentElement = document.getElementById(tabName + 'WorkflowsContent');
            
            if (tabElement) tabElement.classList.add('active');
            if (contentElement) contentElement.classList.add('active');
            
            // Load content based on selected tab
            if (tabName === 'uploaded') {
                // Only load if auth system is ready and user is authenticated
                if (typeof currentUser !== 'undefined' && typeof supabase_jwt !== 'undefined' && isUserAuthenticated()) {
                    loadUserUploadedWorkflows();
                }
            }
        }

        // Deploy workflow to N8N
        async function deployWorkflowToN8N() {
            try {
                if (!isUserAuthenticated()) {
                    showNotification('Please sign in to deploy workflows', 'error');
                    return;
                }

                // Get current workflow data
                const workflowData = window.currentWorkflowData;
                
                if (!workflowData) {
                    showNotification('No workflow data found for deployment', 'error');
                    console.error('No workflow data found in window.currentWorkflowData');
                    return;
                }

                // Show loading state
                const deployBtn = document.querySelector('.deploy-btn');
                const originalText = deployBtn ? deployBtn.innerHTML : 'DEPLOY';
                if (deployBtn) {
                    deployBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>DEPLOYING...';
                    deployBtn.disabled = true;
                }

                // Enhanced credential collection with comprehensive debugging
                console.log('üîç CREDENTIAL COLLECTION: Starting enhanced credential collection...');
                console.log('üîç CREDENTIAL COLLECTION: Current workflow data:', workflowData);
                
                const credentials = {};
                
                // Determine required services from multiple data sources
                let requiredServices = [];
                
                // Source 1: form_config.credentials (detailed)
                if (workflowData.form_config && workflowData.form_config.credentials) {
                    workflowData.form_config.credentials.forEach(cred => {
                        requiredServices.push(cred.service_name);
                    });
                    console.log('üîç CREDENTIAL COLLECTION: Found services from form_config.credentials:', requiredServices);
                }
                
                // Source 2: credentials_required (simple array)
                if (workflowData.credentials_required && Array.isArray(workflowData.credentials_required)) {
                    requiredServices = [...requiredServices, ...workflowData.credentials_required];
                    console.log('üîç CREDENTIAL COLLECTION: Added services from credentials_required:', workflowData.credentials_required);
                }
                
                // Source 3: Check currentWorkflowData
                if (currentWorkflowData && currentWorkflowData.credentials_required) {
                    const currentCreds = Array.isArray(currentWorkflowData.credentials_required) 
                        ? currentWorkflowData.credentials_required 
                        : [currentWorkflowData.credentials_required];
                    requiredServices = [...requiredServices, ...currentCreds];
                    console.log('üîç CREDENTIAL COLLECTION: Added services from currentWorkflowData:', currentCreds);
                }
                
                // Remove duplicates
                requiredServices = [...new Set(requiredServices)];
                console.log('üîç CREDENTIAL COLLECTION: Final required services list:', requiredServices);
                
                // Method 1: Direct DOM query with multiple selectors
                const inputSelectors = [
                    '#credentialFormContainer input[data-service]',
                    'input[data-service]',
                    '[data-service-section] input[data-service]'
                ];
                
                let allCredentialInputs = [];
                inputSelectors.forEach(selector => {
                    const found = document.querySelectorAll(selector);
                    if (found.length > 0) {
                        console.log(`üîç CREDENTIAL COLLECTION: Found ${found.length} inputs with selector: ${selector}`);
                        allCredentialInputs = [...allCredentialInputs, ...Array.from(found)];
                    }
                });
                
                // Remove duplicates based on element reference
                allCredentialInputs = [...new Set(allCredentialInputs)];
                console.log(`üîç CREDENTIAL COLLECTION: Total unique credential inputs found: ${allCredentialInputs.length}`);
                
                // Collect from all found inputs
                allCredentialInputs.forEach((input, index) => {
                    const serviceName = input.getAttribute('data-service');
                    const fieldName = input.name || input.getAttribute('data-field-name');
                    const value = input.value ? input.value.trim() : '';
                    
                    console.log(`üîç CREDENTIAL COLLECTION: Input ${index + 1} - ${serviceName}.${fieldName} = "${value ? '***' : 'EMPTY'}"`);
                    
                    if (serviceName && fieldName && value) {
                        if (!credentials[serviceName]) {
                            credentials[serviceName] = {};
                        }
                        credentials[serviceName][fieldName] = value;
                    }
                });
                
                // Method 2: Use getCredentialsForService for each required service (with fallback)
                requiredServices.forEach(serviceName => {
                    console.log(`üîç CREDENTIAL COLLECTION: Trying getCredentialsForService for ${serviceName}...`);
                    const serviceCreds = getCredentialsForService(serviceName);
                    if (serviceCreds && Object.keys(serviceCreds).length > 0) {
                        console.log(`üîç CREDENTIAL COLLECTION: getCredentialsForService found ${Object.keys(serviceCreds).length} credentials for ${serviceName}`);
                        if (!credentials[serviceName]) {
                            credentials[serviceName] = {};
                        }
                        Object.assign(credentials[serviceName], serviceCreds);
                    } else {
                        console.log(`üîç CREDENTIAL COLLECTION: getCredentialsForService found no credentials for ${serviceName}`);
                    }
                });
       
                // Validate that we have all required credentials
                const missingCredentials = [];
                requiredServices.forEach(serviceName => {
                    if (!credentials[serviceName] || Object.keys(credentials[serviceName]).length === 0) {
                        missingCredentials.push(serviceName);
                    }
                });
                
                if (missingCredentials.length > 0 && requiredServices.length > 0) {
                    console.warn('‚ùå CREDENTIAL VALIDATION: Missing credentials for:', missingCredentials);
                    showNotification(`Missing credentials for: ${missingCredentials.join(', ')}. Please configure all required credentials before deployment.`, 'error');
                    if (deployBtn) {
                        deployBtn.innerHTML = originalText;
                        deployBtn.disabled = false;
                    }
                    return;
                }
                
                if (Object.keys(credentials).length === 0 && requiredServices.length > 0) {
                    console.warn('‚ùå CREDENTIAL VALIDATION: No credentials collected but some are required');
                    showNotification('No credentials found. Please configure your API keys before deployment.', 'error');
                    if (deployBtn) {
                        deployBtn.innerHTML = originalText;
                        deployBtn.disabled = false;
                    }
                    return;
                }

                // Extract workflow JSON from different possible locations - prioritize original data
                let workflowJson = null;
                
                // Priority order: original_workflow_json (preserved from user input) > original_workflow > workflow_json
                if (workflowData.original_workflow_json) {
                    workflowJson = workflowData.original_workflow_json;
                } else if (workflowData.original_workflow) {
                    workflowJson = workflowData.original_workflow;
                } else if (workflowData.workflow_json) {
                    workflowJson = workflowData.workflow_json;
                } else {
                    console.error('No workflow JSON found in any expected field');
                    showNotification('No workflow JSON found for deployment', 'error');
                    if (deployBtn) {
                        deployBtn.innerHTML = originalText;
                        deployBtn.disabled = false;
                    }
                    return;
                }

                // Validate that we have a real N8N workflow (should have nodes)
                if (!workflowJson.nodes || !Array.isArray(workflowJson.nodes)) {
                    console.error('Invalid workflow JSON - missing nodes array');
                    showNotification('Invalid workflow JSON - missing nodes. This appears to be metadata, not the actual workflow.', 'error');
                    if (deployBtn) {
                        deployBtn.innerHTML = originalText;
                        deployBtn.disabled = false;
                    }
                    return;
                }

                // Handle missing template_id - this is critical for backend to save/retrieve
                let templateId = workflowData.template_id || workflowData.id;
                const workflowName = workflowData.workflow_name || workflowData.title || workflowData.manual_workflow_name;
                
                // Prepare deployment payload with proper credential formatting
                const deployPayload = {
                    workflow_json: workflowJson,
                    workflow_name: workflowName,
                    user_credentials: credentials
                };
                
                // Only include template_id if we have one
                if (templateId) {
                    deployPayload.template_id = templateId;
                }
            
                
                // Validate payload before sending
                if (!deployPayload.workflow_json || !deployPayload.workflow_json.nodes) {
                    console.error('üöÄ DEPLOYMENT: Invalid workflow JSON - missing nodes');
                    showNotification('Invalid workflow data for deployment', 'error');
                    if (deployBtn) {
                        deployBtn.innerHTML = originalText;
                        deployBtn.disabled = false;
                    }
                    return;
                }
                
                if (Object.keys(deployPayload.user_credentials).length === 0 && requiredServices.length > 0) {
                    console.error('üöÄ DEPLOYMENT: No credentials provided but services require them');
                    showNotification('Please configure all required credentials before deployment', 'error');
                    if (deployBtn) {
                        deployBtn.innerHTML = originalText;
                        deployBtn.disabled = false;
                    }
                    return;
                }

                // Call deployment API using fetchWithAuth for consistent authentication
                const response = await fetchWithAuth('/api/deploy-workflow-to-n8n', {
                    method: 'POST',
                    body: JSON.stringify(deployPayload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(`üöÄ Workflow deployed successfully! ${result.n8n_workflow_id}`, 'success');
                    
                    // Refresh MCP servers list to show the new server
                    setTimeout(() => {
                        loadMCPServers();
                    }, 1000);
                    
                    // Show success state
                    setTimeout(() => {
                        deployBtn.innerHTML = '<i class="fas fa-check me-2"></i>DEPLOYED!';
                        deployBtn.style.background = 'linear-gradient(90deg, #20c997 0%, #28a745 100%)';
                    }, 500);
                } else {
                    // Handle error
                    const errorMsg = result.error || 'Failed to deploy workflow';
                    console.error('Deployment error:', errorMsg);
                    
                    if (errorMsg.includes('N8N instance configuration missing')) {
                        showNotification('Please configure your N8N instance in your profile first', 'error');
                    } else {
                        showNotification(`Deployment failed: ${errorMsg}`, 'error');
                    }
                    
                    // Reset button
                    if (deployBtn) {
                        deployBtn.innerHTML = originalText;
                        deployBtn.disabled = false;
                    }
                }

            } catch (error) {
                console.error('Error deploying workflow:', error);
                showNotification('An error occurred during deployment', 'error');
                
                // Reset button
                const deployBtn = document.querySelector('.deploy-btn');
                if (deployBtn) {
                    deployBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>DEPLOY TO N8N';
                    deployBtn.disabled = false;
                }
            }
        }

        // Show deploy section when credentials are configured
        function showDeploySection() {
            const deploySection = document.getElementById('deploySection');
            if (deploySection) {
                deploySection.style.display = 'block';
                deploySection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Load workflows when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the uploaded tab as active by default
            setTimeout(() => {
                const uploadedTab = document.getElementById('uploadedTab');
                const uploadedContent = document.getElementById('uploadedWorkflowsContent');
                
                if (uploadedTab && uploadedContent) {
                    // Ensure uploaded tab is active
                    uploadedTab.classList.add('active');
                    uploadedContent.classList.add('active');
                    
                    // Try to load workflows and MCP servers if authentication is ready
                    if (typeof currentUser !== 'undefined' && typeof supabase_jwt !== 'undefined' && isUserAuthenticated()) {
                        loadUserUploadedWorkflows();
                        loadMCPServers();
                    }
                }
            }, 1000);
        });

    </script>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/workflow-credentials.js"></script>
{% endblock %}
